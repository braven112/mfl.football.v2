---
import TheLeagueLayout from '../layouts/TheLeagueLayout.astro';
import leagueAssets from '../data/theleague.assets.json';

const summaryModules = import.meta.glob(
  '../data/mfl-salary-averages-*.json',
  { eager: true }
);

const positionLabels = [
  { key: 'QB', label: 'Quarterback' },
  { key: 'RB', label: 'Running Back' },
  { key: 'WR', label: 'Wide Receiver' },
  { key: 'TE', label: 'Tight End' },
  { key: 'PK', label: 'Kicker' },
  { key: 'Def', label: 'Defense/ST' },
];

const currencyFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});

const formatValue = (value: number | undefined) =>
  typeof value === 'number' && Number.isFinite(value)
    ? currencyFormatter.format(value)
    : 'N/A';

const getModuleData = (mod) =>
  mod && typeof mod === 'object' && 'default' in mod ? mod.default : mod;

const extractSeason = (filepath: string) => {
  const match = filepath.match(/(\d{4})\.json$/);
  return match ? match[1] : null;
};

const summariesBySeason: Record<string, any> = {};
Object.entries(summaryModules).forEach(([path, mod]) => {
  const season = extractSeason(path);
  if (season) summariesBySeason[season] = getModuleData(mod);
});

const seasonOptions = Object.keys(summariesBySeason).sort(
  (a, b) => Number(b) - Number(a)
);
const defaultSeason = seasonOptions[0] ?? seasonOptions.at(-1) ?? '2024';
const currentSummary =
  summariesBySeason[defaultSeason] ??
  (seasonOptions.length ? summariesBySeason[seasonOptions[0]] : {});

const summary = currentSummary?.positions ?? {};
const generatedAt = currentSummary?.metadata?.generatedAt
  ? new Date(currentSummary.metadata.generatedAt)
  : null;
const generatedLabel =
  generatedAt && !Number.isNaN(generatedAt.getTime())
    ? generatedAt.toLocaleString('en-US', {
        dateStyle: 'medium',
        timeStyle: 'short',
      })
    : 'Unknown';

const franchiseMeta = new Map(
  (leagueAssets.teams ?? []).map((team) => [
    team.id,
    {
      name: team.name,
      icon: team.assets?.icons?.[0]?.relativePath,
    },
  ])
);

const franchiseLookup = Object.fromEntries(
  Array.from(franchiseMeta.entries()).map(([id, data]) => [id, data ?? {}])
);

const serializedConfig = JSON.stringify({
  seasons: summariesBySeason,
  seasonOptions,
  defaultSeason,
  franchiseMeta: franchiseLookup,
});
---

<TheLeagueLayout title="Salary Benchmarks">
  <section class="salary-report">
    <header class="salary-report__intro">
      <h1>Salary Benchmarks</h1>
      {seasonOptions.length > 1 && (
        <label class="season-toggle">
          <span>Season:</span>
          <select id="salarySeasonSelect">
            {seasonOptions.map((season) => (
              <option value={season} selected={season === defaultSeason}>
                {season}
              </option>
            ))}
          </select>
        </label>
      )}
      <p>
        League {currentSummary?.metadata?.leagueId ?? 'Unknown'} &middot; Season{' '}
        <span id="salarySeasonLabel">
          {currentSummary?.metadata?.season ?? defaultSeason}
        </span>
        {currentSummary?.metadata?.week
          ? ` &middot; Week ${currentSummary.metadata.week}`
          : ''}
      </p>
      <p class="salary-report__timestamp" id="salarySnapshotLabel">
        Last Snapshot: {generatedLabel}
      </p>
      <p>
        Franchise tag figures use the average of the top three salaries at a
        position, while contract extensions use the average of the top five.
      </p>
    </header>

    <div class="salary-report__grid">
      {positionLabels.map(({ key, label }) => {
        const data = summary[key];
        return (
          <article class="salary-card" data-position={key}>
            <h2>{label}</h2>
            {data ? (
              <>
                <dl class="salary-card__figures">
                  <div>
                    <dt>Franchise Tag (Top 3)</dt>
                    <dd data-franchise-average={key}>{formatValue(data.top3Average)}</dd>
                  </div>
                  <div>
                    <dt>Extension (Top 5)</dt>
                    <dd data-extension-average={key}>{formatValue(data.top5Average)}</dd>
                  </div>
                </dl>
                <p class="salary-card__total" data-total={key}>
                  Tracked Players: {data.totalPlayers ?? 0}
                </p>

                <table class="salary-card__table">
                  <caption>Top Earners</caption>
                  <thead>
                    <tr>
                      <th scope="col">Player</th>
                      <th scope="col">Salary</th>
                    </tr>
                  </thead>
                  <tbody data-top-players={key}>
                    {(data.topPlayers ?? []).map((player) => {
                      const franchise = player?.franchiseId
                        ? franchiseMeta.get(player.franchiseId)
                        : null;
                      return (
                        <tr>
                          <td class="player-cell">
                            {franchise?.icon && (
                              <img
                                src={franchise.icon}
                                alt={`${franchise.name ?? 'Franchise'} icon`}
                                loading="lazy"
                              />
                            )}
                            <span>{player.name}</span>
                          </td>
                          <td>{formatValue(player.salary)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </>
            ) : (
              <p class="salary-card__empty">
                No salary data found for this position.
              </p>
            )}
          </article>
        );
      })}
    </div>
  </section>
</TheLeagueLayout>

<style>
  .salary-report {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .salary-report__intro h1 {
    margin-bottom: 0.25rem;
  }

  .salary-report__intro p {
    margin: 0.25rem 0;
  }

  .salary-report__timestamp {
    font-size: 0.95rem;
    color: #555;
  }

  .season-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .season-toggle select {
    padding: 0.3rem 0.75rem;
    border: 1px solid #ccd3df;
    border-radius: 0.5rem;
    font-size: 1rem;
  }

  .salary-report__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(330px, 1fr));
    gap: 1.5rem;
  }

  .salary-card {
    background: var(--primary-content-bg-color);
    border: 1px solid var(--primary-content-border-color);
    box-shadow: var(--primary-content-boxshadow-size)
      var(--primary-content-boxshadow-color);
    border-radius: 0.75rem;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .salary-card h2 {
    margin: 0;
    font-size: 1.2rem;
  }

  .salary-card__figures {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin: 0;
  }

  .salary-card__figures div {
    display: flex;
    flex-direction: column;
  }

  .salary-card__figures dt {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.2rem;
  }

  .salary-card__figures dd {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--primary-color);
  }

  .salary-card__total {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
  }

  .salary-card__table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .salary-card__table caption {
    text-align: left;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .salary-card__table th,
  .salary-card__table td {
    padding: 0.35rem 0;
    border-bottom: 1px solid #eee;
  }

  .salary-card__table th {
    text-align: left;
    font-size: 0.85rem;
    color: #555;
  }

  .salary-card__table td:last-child {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .salary-card__table tr:last-child td {
    border-bottom: none;
  }

  :global(.player-cell) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  :global(.player-cell img) {
    width: 32px;
    height: 32px;
    object-fit: cover;
  }

  .salary-card__empty {
    margin: 0;
    font-size: 0.95rem;
    color: #777;
  }

  @media (max-width: 768px) {
    .salary-card__figures {
      flex-direction: column;
    }
  }
</style>

<script
  type="application/json"
  id="salary-config"
  set:html={serializedConfig}
></script>

<script type="module">
  const summaryConfigEl = document.getElementById('salary-config');
  if (summaryConfigEl) {
    const { seasons = {}, defaultSeason, franchiseMeta = {} } = JSON.parse(
      summaryConfigEl.textContent
    );
    const selectEl = document.getElementById('salarySeasonSelect');
    const seasonLabel = document.getElementById('salarySeasonLabel');
    const snapshotLabel = document.getElementById('salarySnapshotLabel');

    const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    });

    const formatCurrency = (value) => {
      if (!Number.isFinite(value)) return 'N/A';
      return currencyFormatter.format(Math.round(value));
    };

    const renderSeason = (seasonKey) => {
      const summary = seasons?.[seasonKey];
      if (!summary) return;
      seasonLabel.textContent = summary?.metadata?.season ?? seasonKey;
      const generatedAt = summary?.metadata?.generatedAt
        ? new Date(summary.metadata.generatedAt)
        : null;
      snapshotLabel.textContent = `Last Snapshot: ${
        generatedAt && !Number.isNaN(generatedAt.getTime())
          ? generatedAt.toLocaleString('en-US', {
              dateStyle: 'medium',
              timeStyle: 'short',
            })
          : 'Unknown'
      }`;

      (summary?.positions
        ? Object.entries(summary.positions)
        : []
      ).forEach(([position, data]) => {
        const franCell = document.querySelector(
          `[data-franchise-average="${position}"]`
        );
        const extCell = document.querySelector(
          `[data-extension-average="${position}"]`
        );
        const totalEl = document.querySelector(`[data-total="${position}"]`);
        const playersBody = document.querySelector(
          `[data-top-players="${position}"]`
        );

        if (franCell) franCell.textContent = formatCurrency(data?.top3Average ?? 0);
        if (extCell) extCell.textContent = formatCurrency(data?.top5Average ?? 0);
        if (totalEl) totalEl.textContent = `Tracked Players: ${data?.totalPlayers ?? 0}`;
        if (playersBody) {
          const rows = (data?.topPlayers ?? [])
            .map((player) => {
              const franchise = player?.franchiseId
                ? franchiseMeta[player.franchiseId]
                : null;
              const iconMarkup = franchise?.icon
                ? `<img src="${franchise.icon}" alt="${franchise.name ?? 'Franchise'} icon" loading="lazy" />`
                : '';
              return `
                <tr>
                  <td class="player-cell">
                    ${iconMarkup}
                    <span>${player.name ?? ''}</span>
                  </td>
                  <td>${formatCurrency(player.salary)}</td>
                </tr>`;
            })
            .join('');
          playersBody.innerHTML =
            rows || '<tr><td colspan="2" class="player-cell">No players tracked.</td></tr>';
        }
      });
    };

    renderSeason(defaultSeason);
    selectEl?.addEventListener('change', (event) => {
      renderSeason(event.target.value);
    });
  }
</script>
