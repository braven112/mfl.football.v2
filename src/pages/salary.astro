---
import Layout from '../layouts/Layout.astro';
import salarySummary from '../data/mfl-salary-averages-2024.json';
import leagueAssets from '../data/theleague.assets.json';

const positionLabels = [
  { key: 'QB', label: 'Quarterback' },
  { key: 'RB', label: 'Running Back' },
  { key: 'WR', label: 'Wide Receiver' },
  { key: 'TE', label: 'Tight End' },
  { key: 'PK', label: 'Kicker' },
  { key: 'Def', label: 'Defense/ST' },
];

const currencyFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});

const formatValue = (value: number | undefined) =>
  typeof value === 'number' && Number.isFinite(value)
    ? currencyFormatter.format(value)
    : 'N/A';

const summary = salarySummary.positions ?? {};
const generatedAt = new Date(salarySummary.metadata?.generatedAt ?? '');
const generatedLabel = Number.isNaN(generatedAt.getTime())
  ? 'Unknown'
  : generatedAt.toLocaleString('en-US', {
      dateStyle: 'medium',
      timeStyle: 'short',
    });

const franchiseMeta = new Map(
  (leagueAssets.teams ?? []).map((team) => [
    team.id,
    {
      name: team.name,
      icon: team.assets?.icons?.[0]?.relativePath,
    },
  ])
);
---

<Layout title="Salary Benchmarks">
  <section class="salary-report">
    <header class="salary-report__intro">
      <h1>Salary Benchmarks</h1>
      <p>
        League {salarySummary.metadata?.leagueId ?? 'Unknown'} &middot; Season{' '}
        {salarySummary.metadata?.season ?? 'Unknown'}{salarySummary.metadata?.week
          ? ` &middot; Week ${salarySummary.metadata.week}`
          : ''}
      </p>
      <p class="salary-report__timestamp">Last Snapshot: {generatedLabel}</p>
      <p>
        Franchise tag figures use the average of the top three salaries at a
        position, while contract extensions use the average of the top five.
      </p>
    </header>

    <div class="salary-report__grid">
      {positionLabels.map(({ key, label }) => {
        const data = summary[key];
        return (
          <article class="salary-card" data-position={key}>
            <h2>{label}</h2>
            {data ? (
              <>
                <dl class="salary-card__figures">
                  <div>
                    <dt>Franchise Tag (Top 3)</dt>
                    <dd>{formatValue(data.top3Average)}</dd>
                  </div>
                  <div>
                    <dt>Extension (Top 5)</dt>
                    <dd>{formatValue(data.top5Average)}</dd>
                  </div>
                </dl>
                <p class="salary-card__total">
                  Tracked Players: {data.totalPlayers ?? 0}
                </p>

                <table class="salary-card__table">
                  <caption>Top Earners</caption>
                  <thead>
                    <tr>
                      <th scope="col">Player</th>
                      <th scope="col">Salary</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(data.topPlayers ?? []).map((player) => {
                      const franchise = player?.franchiseId
                        ? franchiseMeta.get(player.franchiseId)
                        : null;
                      return (
                        <tr>
                          <td class="player-cell">
                            {franchise?.icon && (
                              <img
                                src={franchise.icon}
                                alt={`${franchise.name ?? 'Franchise'} icon`}
                                loading="lazy"
                              />
                            )}
                            <span>{player.name}</span>
                          </td>
                          <td>{formatValue(player.salary)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </>
            ) : (
              <p class="salary-card__empty">
                No salary data found for this position.
              </p>
            )}
          </article>
        );
      })}
    </div>
  </section>
</Layout>

<style>
  .salary-report {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding-top: 6rem;
  }

  .salary-report__intro h1 {
    margin-bottom: 0.25rem;
  }

  .salary-report__intro p {
    margin: 0.25rem 0;
  }

  .salary-report__timestamp {
    font-size: 0.95rem;
    color: #555;
  }

  .salary-report__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
  }

  .salary-card {
    background: var(--primary-content-bg-color);
    border: 1px solid var(--primary-content-border-color);
    box-shadow: var(--primary-content-boxshadow-size)
      var(--primary-content-boxshadow-color);
    border-radius: 0.75rem;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .salary-card h2 {
    margin: 0;
    font-size: 1.2rem;
  }

  .salary-card__figures {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin: 0;
  }

  .salary-card__figures div {
    display: flex;
    flex-direction: column;
  }

  .salary-card__figures dt {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.2rem;
  }

  .salary-card__figures dd {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--primary-color);
  }

  .salary-card__total {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
  }

  .salary-card__table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .salary-card__table caption {
    text-align: left;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .salary-card__table th,
  .salary-card__table td {
    padding: 0.35rem 0;
    border-bottom: 1px solid #eee;
  }

  .salary-card__table th {
    text-align: left;
    font-size: 0.85rem;
    color: #555;
  }

  .salary-card__table td:last-child {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .salary-card__table tr:last-child td {
    border-bottom: none;
  }

  .player-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .player-cell img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ddd;
    background: #fff;
  }

  .salary-card__empty {
    margin: 0;
    font-size: 0.95rem;
    color: #777;
  }

  @media (max-width: 768px) {
    .salary-card__figures {
      flex-direction: column;
    }
  }
</style>
