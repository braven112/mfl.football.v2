---
import Layout from '../layouts/Layout.astro';
import salarySummary from '../data/mfl-salary-averages-2024.json';

const extensionPositions = [
  { key: 'QB', label: 'Quarterback' },
  { key: 'RB', label: 'Running Back' },
  { key: 'WR', label: 'Wide Receiver' },
  { key: 'TE', label: 'Tight End' },
  { key: 'PK', label: 'Kicker' },
];

const salaryTabs = [2, 3, 4];
const extensionSalaries = extensionPositions.reduce((acc, { key }) => {
  acc[key] = salarySummary.positions?.[key]?.top5Average ?? 0;
  return acc;
}, {});
const franchiseSalaries = extensionPositions.reduce((acc, { key }) => {
  acc[key] = salarySummary.positions?.[key]?.top3Average ?? 0;
  return acc;
}, {});

const currencyFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});

const serializedConfig = JSON.stringify({
  positionKeys: extensionPositions.map(({ key }) => key),
  extensionSalaries,
  franchiseSalaries,
  salaryTabs,
});
---

<Layout title="Contract Tools">
  <section class="calculator">
    <div class="calculator__card" id="rookie-extension-calculator">
      <h1>Contract Tools</h1>

      <label class="field-label">Contract Type:</label>
      <div class="toggle-switch toggle-switch--grid">
        <input type="radio" id="franExt" name="extType" value="franchise" />
        <label for="franExt">Franchise Tag</label>
        <input type="radio" id="transExt" name="extType" value="transition" />
        <label for="transExt">Veteran Extension</label>
        <input type="radio" id="rookieExt" name="extType" value="rookie" checked />
        <label for="rookieExt">Rookie Extension</label>
      </div>

      <label class="field-label" for="currentSalary">Current Salary:</label>
      <input type="text" id="currentSalary" class="currency-input" value="$1,500,000" placeholder="$0" inputmode="decimal" />

      <label class="field-label">Position:</label>
      <div class="toggle-switch toggle-switch--compact">
        {extensionPositions.map(({ key }) => (
          <>
            <input type="radio" id={`pos${key}`} name="position" value={key} checked={key === 'QB'} />
            <label for={`pos${key}`}>{key}</label>
          </>
        ))}
      </div>

      <label class="field-label">Years Remaining:</label>
      <div class="toggle-switch toggle-switch--compact">
        {salaryTabs.map((years) => (
          <>
            <input type="radio" id={`yr${years}`} name="yearsRemaining" value={years} checked={years === 3} />
            <label for={`yr${years}`}>{years}</label>
          </>
        ))}
      </div>

      <div id="extensionLengthContainer">
        <label class="field-label">Extension Length:</label>
        <div class="toggle-switch toggle-switch--compact">
          <input type="radio" id="ext1" name="extensionLength" value="1" />
          <label for="ext1">1 Yr</label>
          <input type="radio" id="ext2" name="extensionLength" value="2" checked />
          <label for="ext2">2 Yr</label>
        </div>
      </div>

      <button type="button" id="calculateBtn">Calculate</button>
      <div class="result" id="result">Use the calculator above, then generate your message here.</div>
    </div>

    <section class="salary-reference">
      <div class="salary-reference__panel">
        <h2>Extension Salaries<br />(Top 5)</h2>
        <p>Used for rookie and veteran extensions.</p>
        <table>
          <thead>
            <tr>
              <th>Position</th>
              <th>Average Salary</th>
            </tr>
          </thead>
          <tbody>
            {extensionPositions.map(({ key, label }) => (
              <tr>
                <td>{label}</td>
                <td>{currencyFormatter.format(extensionSalaries[key] ?? 0)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div class="salary-reference__panel">
        <h2>Franchise Tag Salaries<br />(Top 3)</h2>
        <p>Franchise tags are locked to one-year deals.</p>
        <table>
          <thead>
            <tr>
              <th>Position</th>
              <th>Average Salary</th>
            </tr>
          </thead>
          <tbody>
            {extensionPositions.map(({ key, label }) => (
              <tr>
                <td>{label}</td>
                <td>{currencyFormatter.format(franchiseSalaries[key] ?? 0)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  </section>
</Layout>

<style>
  .calculator {
    padding: 4rem 1rem;
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(240px, 1fr);
    gap: 1.5rem;
    background: #e7ebef;
  }

  .calculator__card {
    padding: 2rem;
    background: #fff;
    border-radius: 1rem;
    border: 1px solid #d7dce3;
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    display: grid;
    gap: 1rem;
    align-self: flex-start;
  }

  .calculator__card h1 {
    margin: 0;
    text-align: center;
    background: #0d3b78;
    color: #fff;
    padding: 0.85rem;
    border-radius: 0.75rem;
    font-size: 2.4rem;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .field-label {
    font-weight: 600;
    margin-bottom: 0.15rem;
  }

  .currency-input {
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 0.35rem;
    font-size: 1.15rem;
  }

  .toggle-switch {
    display: flex;
    border-radius: 1.6rem;
    background: #f7f8fb;
    border: 1px solid #d7dce3;
    padding: 0.25rem;
    gap: 0.25rem;
  }

  .toggle-switch input {
    display: none;
  }

  .toggle-switch label {
    flex: 1;
    text-align: center;
    padding: 0.5rem 0.25rem;
    border-radius: 1rem;
    cursor: pointer;
    font-weight: 600;
    color: #003366;
  }

  .toggle-switch input:checked + label {
    background: #238047;
    color: #fff;
    box-shadow: 0 10px 20px rgba(34, 197, 94, 0.25);
  }

  .toggle-switch--compact label {
    padding: 0.4rem 0.25rem;
  }

  button {
    background: #2f8a4d;
    color: #fff;
    border: none;
    padding: 0.95rem 1.5rem;
    border-radius: 999px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 0.03em;
    font-size: 1rem;
  }

  button:hover {
    background: #1f6d39;
  }

  button:active {
    transform: translateY(1px);
  }

  #calculateBtn {
    width: 100%;
  }

  .hidden {
    display: none !important;
  }

  .result {
    padding: 0.75rem;
    border: 1px solid #d7dce3;
    border-radius: 0.35rem;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
    font-size: 0.95rem;
    background: #fff;
  }

  .bbcode {
    font-family: monospace;
    background: #1f2937;
    color: #d1d5db;
    padding: 0.75rem;
    border-radius: 0.35rem;
    margin-top: 0.5rem;
    white-space: pre-wrap;
  }

  .salary-reference {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-self: flex-start;
  }

  .salary-reference__panel {
    background: #fff;
    border: 1px solid #d7dce3;
    border-radius: 0.9rem;
    padding: 1.25rem 1.5rem;
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
  }

  .salary-reference__panel h2 {
    margin: 0 0 0.3rem;
  }

  .salary-reference__panel p {
    margin: 0 0 0.75rem;
    color: #555;
    font-size: 0.9rem;
  }

  .salary-reference table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }

  .salary-reference th,
  .salary-reference td {
    padding: 0.35rem 0;
    border-bottom: 1px solid #eee;
  }

  .salary-reference td:last-child {
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
  }

  .toggle-switch--grid {
    flex-wrap: wrap;
  }

  @media (max-width: 1024px) {
    .calculator {
      grid-template-columns: 1fr;
    }

    .salary-reference {
      flex-direction: row;
      flex-wrap: wrap;
    }
  }

  @media (max-width: 640px) {
    .salary-reference {
      flex-direction: column;
    }
  }

  @media (max-width: 590px) {
    .toggle-switch--grid {
      padding: 0.4rem;
      gap: 0.35rem;
    }

    .toggle-switch--grid label {
      flex: 1 1 calc(50% - 0.35rem);
      border-radius: 0.6rem;
    }

    button {
      width: 100%;
    }
  }
</style>

<script
  type="application/json"
  id="calculator-config"
  set:html={serializedConfig}
></script>

<script type="module">
  const {
    positionKeys,
    extensionSalaries,
    franchiseSalaries,
    salaryTabs,
  } = JSON.parse(document.getElementById('calculator-config').textContent);

  const currencyFormatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });

  const formatCurrency = (value) => {
    if (!Number.isFinite(value)) return '$0';
    return currencyFormatter.format(Math.round(value));
  };

  const parseCurrency = (value) => {
    if (!value) return 0;
    const numeric = parseFloat(value.replace(/[^\d.-]/g, ''));
    return Number.isNaN(numeric) ? 0 : numeric;
  };

  const formatInput = (input) => {
    input.value = formatCurrency(parseCurrency(input.value));
  };

  const toggleExtensionLength = () => {
    const container = document.getElementById('extensionLengthContainer');
    const type = document.querySelector('input[name="extType"]:checked').value;
    const shouldShow = type === 'transition';
    container.classList.toggle('hidden', !shouldShow);
    if (type === 'rookie') {
      document.getElementById('ext2').checked = true;
    }
  };

  const getReferenceSalary = (position, type) => {
    if (type === 'franchise') return franchiseSalaries[position] ?? 0;
    return extensionSalaries[position] ?? 0;
  };

  const calculateExtension = () => {
    const salary = parseCurrency(document.getElementById('currentSalary').value);
    const yearsRemaining = Number(document.querySelector('input[name="yearsRemaining"]:checked').value);
    const position = document.querySelector('input[name="position"]:checked').value;
    const extensionType = document.querySelector('input[name="extType"]:checked').value;
    const extensionLength =
      extensionType === 'rookie'
        ? 2
        : extensionType === 'franchise'
          ? 1
          : Number(document.querySelector('input[name="extensionLength"]:checked').value);
    const avgSalary = getReferenceSalary(position, extensionType);

    const totalExtensionValue = avgSalary * extensionLength;
    const totalYears = yearsRemaining + extensionLength;
    const newSalary = Math.round(salary + totalExtensionValue / totalYears);
    const label =
      extensionType === 'franchise'
        ? 'Franchise Tag'
        : extensionType === 'rookie'
          ? 'Rookie Extension'
          : 'Transition Extension';
    const bbcode = `[b]${label}[/b]
Position: ${position}
Term: ${extensionLength} year(s)
New Salary: ${formatCurrency(newSalary)}
Total Contract Length: ${totalYears} years`;

    const result = document.getElementById('result');
    result.innerHTML = `
      <strong>Results:</strong><br/>
      New Salary: ${formatCurrency(newSalary)}<br/>
      Total Contract Length: ${totalYears} years<br/>
      Reference Salary Used: ${formatCurrency(avgSalary)}
      <div class="bbcode" id="bbcodeOutput">${bbcode}</div>
      <button type="button" id="copyBtn">Copy Message Board Post</button>
    `;

    document.getElementById('copyBtn').addEventListener('click', () => {
      navigator.clipboard
        .writeText(bbcode)
        .then(() => alert('BBCode copied!'))
        .catch(() => alert('Unable to copy BBCode.'));
    });
  };

  document.addEventListener('DOMContentLoaded', () => {
    toggleExtensionLength();
    document.querySelectorAll('.currency-input').forEach((input) => {
      input.addEventListener('blur', () => formatInput(input));
    });

    document.querySelectorAll('input[name="extType"]').forEach((radio) => {
      radio.addEventListener('change', toggleExtensionLength);
    });

    document.getElementById('calculateBtn').addEventListener('click', calculateExtension);
  });
</script>
