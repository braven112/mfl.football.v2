---
import TheLeagueLayout from '../../layouts/TheLeagueLayout.astro';
import MatchupSelector from '../../components/theleague/MatchupSelector.astro';
import SundayTicketMultiView from '../../components/theleague/SundayTicketMultiView.astro';
import { getTeamProjection } from '../../utils/projections';
import { normalizeTeamCode, getNFLTeamLogo, getStadiumName } from '../../utils/nfl';
import { parseMatchupParams, resolveCurrentMatchup } from '../../utils/matchup-routing';
import type { Matchup, FantasyTeam, NFLGame } from '../../types/matchup-previews';

export const prerender = false; // Enable server-side rendering for URL parameter handling

// Load the NFL-enhanced matchup story
import storyData from '../../../data/theleague/test-matchup-story-nfl.json';

// Load MFL data for real projections and team data
import rostersData from '../../../data/theleague/mfl-feeds/2025/rosters.json';
import projectedScoresData from '../../../data/theleague/mfl-feeds/2025/projectedScores.json';
import playersData from '../../../data/theleague/mfl-feeds/2025/players.json';
import leagueData from '../../../data/theleague/mfl-feeds/2025/league.json';
import weeklyResults from '../../../data/theleague/mfl-feeds/2025/weekly-results.json';
import leagueAssets from '../../data/theleague.assets.json';

// Load AI-generated fantasy-contextual NFL game blurbs
import matchupBlurbsData from '../../../data/theleague/matchup-nfl-blurbs-0013-0015.json';

// Load NFL schedule for game details
import nflSchedule from '../../../data/theleague/nfl-cache/week15-2025.json';

// Load international broadcast mappings
import broadcastMappings from '../../../data/theleague/broadcast-mappings.json';

// Load ESPN news articles
import nflNewsData from '../../../data/theleague/nfl-news-week15.json';

// Calculate real projections from MFL data
const homeProjection = getTeamProjection('0013', rostersData, projectedScoresData);
const awayProjection = getTeamProjection('0015', rostersData, projectedScoresData);

// Build real NFL games data from rosters
function buildNFLGamesFromRosters(homeTeamId: string, awayTeamId: string) {
  // Get rosters for both teams
  const homeRoster = rostersData.rosters.franchise.find((f: any) => f.id === homeTeamId);
  const awayRoster = rostersData.rosters.franchise.find((f: any) => f.id === awayTeamId);

  if (!homeRoster || !awayRoster) return [];

  // Build player maps
  const playerMap = new Map();
  const playersList = Array.isArray(playersData.players.player)
    ? playersData.players.player
    : [playersData.players.player];
  playersList.forEach((p: any) => playerMap.set(p.id, p));

  const projMap = new Map();
  const projList = Array.isArray(projectedScoresData.projectedScores.playerScore)
    ? projectedScoresData.projectedScores.playerScore
    : [projectedScoresData.projectedScores.playerScore];
  projList.forEach((p: any) => projMap.set(p.id, parseFloat(p.score) || 0));

  // Group players by NFL team
  const nflGamesMap = new Map();

  function addPlayer(playerId: string, fantasyTeamId: string) {
    const player = playerMap.get(playerId);
    if (!player) return;

    const nflTeam = normalizeTeamCode(player.team);
    const projection = projMap.get(playerId) || 0;

    if (!nflGamesMap.has(nflTeam)) {
      nflGamesMap.set(nflTeam, { team: nflTeam, players: [] });
    }

    nflGamesMap.get(nflTeam).players.push({
      id: playerId,
      name: player.name,
      position: player.position,
      nflTeam,
      projectedPoints: projection,
      fantasyTeamId,
      espnId: player.espn_id || ''
    });
  }

  // Add all players from both teams
  const homePlayers = Array.isArray(homeRoster.player) ? homeRoster.player : [homeRoster.player];
  const awayPlayers = Array.isArray(awayRoster.player) ? awayRoster.player : [awayRoster.player];

  homePlayers.forEach((p: any) => addPlayer(p.id, homeTeamId));
  awayPlayers.forEach((p: any) => addPlayer(p.id, awayTeamId));

  // Match NFL teams to create games
  const schedule = nflSchedule.schedule || {};
  const gameDetails = nflSchedule.gameDetails || {};
  const processedGames = new Set();
  const games: any[] = [];

  Object.entries(schedule).forEach(([teamCode, opponentCode]) => {
    const team1 = normalizeTeamCode(teamCode as string);
    const team2 = normalizeTeamCode(opponentCode as string);
    const key = [team1, team2].sort().join('-');

    if (processedGames.has(key)) return;
    processedGames.add(key);

    // Get players for both teams
    const team1Data = nflGamesMap.get(team1);
    const team2Data = nflGamesMap.get(team2);
    const allPlayers = [
      ...(team1Data?.players || []),
      ...(team2Data?.players || [])
    ];

    if (allPlayers.length === 0) return; // No fantasy players in this game

    // Get game details
    const detailKey1 = `${team1}_vs_${team2}`;
    const detailKey2 = `${team2}_vs_${team1}`;
    const details = (gameDetails as any)[detailKey1] || (gameDetails as any)[detailKey2] || {};

    games.push({
      team1,
      team2,
      players: allPlayers,
      playerCount: allPlayers.length,
      day: details.day || 'Sun',
      time: details.time || '10:00 AM PST',
      channel: details.channel || '',
      channelLogo: details.channelLogo || '',
      weather: details.weather || '',
      temp: details.temp || '',
      conditions: details.conditions || ''
    });
  });

  // Sort games: chronologically first, then by fantasy impact for same-time games
  return games.sort((a, b) => {
    // Helper to convert time to sortable format
    const getTimeValue = (game: any) => {
      const dayOrder: Record<string, number> = { 'Thu': 0, 'Fri': 1, 'Sat': 2, 'Sun': 3, 'Mon': 4, 'Tue': 5, 'Wed': 6 };
      const dayValue = dayOrder[game.day as string] ?? 3; // Default to Sunday

      // Parse time like "10:00 AM PST" or "5:15 PM PST"
      const timeMatch = game.time.match(/(\d+):(\d+)\s*(AM|PM)/i);
      if (!timeMatch) return dayValue * 10000; // Day only if no time

      let hours = parseInt(timeMatch[1]);
      const minutes = parseInt(timeMatch[2]);
      const period = timeMatch[3].toUpperCase();

      // Convert to 24-hour format
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      // Return combined value: day * 10000 + hours * 100 + minutes
      return dayValue * 10000 + hours * 100 + minutes;
    };

    // Helper to calculate fantasy score
    const getFantasyScore = (game: any) => {
      return game.players.reduce((total: number, p: any) => {
        return total + (parseFloat(p.projectedPoints) || 0);
      }, 0);
    };

    const timeA = getTimeValue(a);
    const timeB = getTimeValue(b);

    // If times are different, sort chronologically
    if (timeA !== timeB) {
      return timeA - timeB;
    }

    // If times are the same, sort by fantasy impact (descending)
    return getFantasyScore(b) - getFantasyScore(a);
  });
}

// Generate multiple matchups for navigation using real MFL playoff bracket data
async function generateAllMatchups(week: number): Promise<Matchup[]> {
  // Import MFL schedule integration
  const { getWeeklyMatchupsWithMFL } = await import('../../utils/matchup-service');
  
  try {
    // Use MFL schedule integration to get real playoff bracket matchups
    const matchups = await getWeeklyMatchupsWithMFL(week, {
      leagueId: '13522',
      year: '2025',
      enablePlayoffBrackets: true,
    });
    
    if (matchups && matchups.length > 0) {
      console.log(`‚úÖ Loaded ${matchups.length} matchups from MFL playoff bracket data for week ${week}`);
      return matchups;
    }
  } catch (error) {
    console.warn('Failed to load MFL schedule data, falling back to algorithmic generation:', error);
  }
  
  // Fallback to algorithmic generation if MFL integration fails
  console.log('Using fallback matchup generation');
  
  // Get real team data from MFL league data
  const franchises = leagueData.league.franchises.franchise;
  
  // Create team lookup with assets
  const teamLookup = new Map();
  franchises.forEach((franchise: any) => {
    // Find matching assets
    const assetTeam = leagueAssets.teams.find((team: any) => team.id === franchise.id);
    
    teamLookup.set(franchise.id, {
      id: franchise.id,
      name: franchise.name,
      ownerName: assetTeam?.name || franchise.name, // Use asset name if available
      abbrev: franchise.abbrev,
      icon: franchise.icon,
      division: franchise.division,
    });
  });

  const matchups: Matchup[] = [];
  
  // Generate matchups using a rotating schedule algorithm
  // This creates more realistic weekly matchups
  const teamIds = Array.from(teamLookup.keys()).sort();
  const matchupCount = Math.floor(teamIds.length / 2);
  
  // Create weekly rotation based on week number
  const rotationOffset = (week - 1) % (teamIds.length - 1);
  
  for (let i = 0; i < matchupCount; i++) {
    let homeIndex, awayIndex;
    
    if (i === 0) {
      // First team stays fixed, opponent rotates
      homeIndex = 0;
      awayIndex = 1 + rotationOffset;
    } else {
      // Other teams pair up in rotating fashion
      homeIndex = i;
      awayIndex = teamIds.length - i + rotationOffset;
    }
    
    // Wrap around if needed
    awayIndex = awayIndex % teamIds.length;
    if (awayIndex === homeIndex) {
      awayIndex = (awayIndex + 1) % teamIds.length;
    }
    
    const homeTeamId = teamIds[homeIndex];
    const awayTeamId = teamIds[awayIndex];
    
    if (!homeTeamId || !awayTeamId) continue;
    
    const homeTeamData = teamLookup.get(homeTeamId);
    const awayTeamData = teamLookup.get(awayTeamId);
    
    if (!homeTeamData || !awayTeamData) continue;
    
    // Get real projections from MFL data
    const homeProjection = getTeamProjection(homeTeamId, rostersData, projectedScoresData);
    const awayProjection = getTeamProjection(awayTeamId, rostersData, projectedScoresData);
    
    // Build NFL games for this matchup
    const nflGames = buildNFLGamesFromRosters(homeTeamId, awayTeamId);
    
    const homeTeam: FantasyTeam = {
      id: homeTeamData.id,
      name: homeTeamData.name,
      ownerName: homeTeamData.ownerName,
      projectedPoints: homeProjection,
    };
    
    const awayTeam: FantasyTeam = {
      id: awayTeamData.id,
      name: awayTeamData.name,
      ownerName: awayTeamData.ownerName,
      projectedPoints: awayProjection,
    };
    
    const matchup: Matchup = {
      id: `matchup-${i + 1}`,
      week,
      homeTeam,
      awayTeam,
      nflGames: nflGames || [],
      gameState: 'pre-game',
      projectedTotal: homeProjection + awayProjection,
      analysis: `This ${week >= 15 ? 'playoff' : 'regular season'} matchup features ${awayTeam.name} visiting ${homeTeam.name}. Both teams are looking to make a statement in Week ${week}.`,
      lastUpdated: new Date(),
    };
    
    matchups.push(matchup);
  }
  
  return matchups;
}

// Get URL parameters and resolve current matchup
const url = Astro.url;
const routeParams = parseMatchupParams(url);
const week = routeParams.week || 15;

// Generate all available matchups
const allMatchups = await generateAllMatchups(week);

// Ensure allMatchups is an array
if (!Array.isArray(allMatchups)) {
  console.error('allMatchups is not an array:', allMatchups);
  throw new Error('Failed to generate matchups - invalid data structure');
}

console.log(`Generated ${allMatchups.length} matchups for week ${week}`);

// Resolve current matchup from URL parameters
let currentMatchup = resolveCurrentMatchup(allMatchups, routeParams);

// If no matchup found, redirect to first available matchup
if (!currentMatchup && allMatchups.length > 0) {
  const defaultMatchup = allMatchups[0];
  const redirectUrl = new URL(url);
  redirectUrl.searchParams.set('matchup', defaultMatchup.id);
  redirectUrl.searchParams.set('week', week.toString());
  
  return Astro.redirect(redirectUrl.toString());
}

// If still no matchup, show error
if (!currentMatchup) {
  throw new Error('No matchups available for this week');
}

// Build NFL games for the current matchup
const realNFLGames = buildNFLGamesFromRosters(currentMatchup.homeTeam.id, currentMatchup.awayTeam.id);

// Legacy matchup object for compatibility with existing code
const matchup = {
  week: currentMatchup.week,
  home: {
    id: currentMatchup.homeTeam.id,
    name: currentMatchup.homeTeam.name,
    record: '10-8', // Mock data - would come from MFL in real implementation
    seed: 4,
    projection: currentMatchup.homeTeam.projectedPoints || 0
  },
  away: {
    id: currentMatchup.awayTeam.id,
    name: currentMatchup.awayTeam.name,
    record: '14-4', // Mock data - would come from MFL in real implementation
    seed: 5,
    projection: currentMatchup.awayTeam.projectedPoints || 0
  },
  story: storyData.story,
  nflMatchups: storyData.nflMatchups,
  nflGames: realNFLGames.length > 0 ? realNFLGames : currentMatchup.nflGames,
  bracket: week >= 15 ? 'Playoffs - First Round' : 'Regular Season'
};

// Helper to get ESPN player headshot URL
function getPlayerHeadshot(espnId: string) {
  if (!espnId) return 'https://www49.myfantasyleague.com/player_photos_2010/no_photo_available.jpg';
  return `https://a.espncdn.com/combiner/i?img=/i/headshots/nfl/players/full/${espnId}.png&w=96&h=70`;
}

// Prepare games for Sunday Ticket Multi-View component
const nflGamesForMultiView = (matchup.nflGames || []).map((game: any) => ({
  id: `${game.team1}-${game.team2}`,
  team1: game.team1,
  team2: game.team2,
  players: game.players || [],
  playerCount: game.playerCount || (game.players?.length || 0),
  day: game.day || 'Sun',
  time: game.time || '10:00 AM PST',
  score: game.score,
  projectedPoints: game.projectedPoints,
  actualPoints: game.actualPoints
}));

// Helper to get matchup data for a specific player
function getPlayerMatchupData(playerName: string, nflMatchups: any[]) {
  if (!nflMatchups) return null;

  return nflMatchups.find((m: any) => m.name === playerName) || null;
}

// Helper to get AI blurb for a game
function getGameBlurb(team1: string, team2: string) {
  const matchupKey = `${normalizeTeamCode(team1)} @ ${normalizeTeamCode(team2)}`;
  const matchupKeyReverse = `${normalizeTeamCode(team2)} @ ${normalizeTeamCode(team1)}`;

  const blurb = matchupBlurbsData.blurbs?.find((b: any) =>
    b.nflMatchup === matchupKey || b.nflMatchup === matchupKeyReverse
  );

  return blurb || null;
}

// Helper to get ESPN news for a game
function getGameNews(team1: string, team2: string) {
  const t1 = normalizeTeamCode(team1);
  const t2 = normalizeTeamCode(team2);

  // Get news for both teams (top article from each)
  const team1News = (nflNewsData.teams as any)?.[t1]?.[0];
  const team2News = (nflNewsData.teams as any)?.[t2]?.[0];

  // Return the most recent article
  if (!team1News && !team2News) return null;
  if (!team1News) return team2News;
  if (!team2News) return team1News;

  // Compare published dates and return most recent
  const date1 = new Date(team1News.published);
  const date2 = new Date(team2News.published);

  return date1 > date2 ? team1News : team2News;
}
---

<TheLeagueLayout title={`Week ${week} ${week >= 15 ? 'Playoff' : 'Regular Season'} Preview | The League`}>
  <div class="matchup-preview-container">
    <!-- Matchup Navigation -->
    <MatchupSelector 
      currentMatchup={currentMatchup}
      availableMatchups={allMatchups}
      week={week}
    />

    <!-- Scoreboard Header -->
    <div class="scoreboard-header">
      <div class="bracket-label">{matchup.bracket}</div>
      <div class="week-label">Week {matchup.week}</div>

      <div class="matchup-scoreboard">
        <!-- Away Team (Left) -->
        <div class="team away-team">
          <div class="team-icon-container">
            <img
              src={`/assets/theleague/icons/${matchup.away.id}.png`}
              alt={matchup.away.name}
              class="team-icon"
            />
          </div>
          <div class="team-info">
            <div class="team-name">{matchup.away.name}</div>
            <div class="team-record">
              <span class="seed">#{matchup.away.seed} Seed</span>
              <span class="separator">‚Ä¢</span>
              <span class="record">{matchup.away.record}</span>
            </div>
          </div>
          <div class="team-projection">
            <div class="projection-label">Proj</div>
            <div class="projection-value">{matchup.away.projection.toFixed(1)}</div>
          </div>
        </div>

        <!-- VS Divider -->
        <div class="vs-divider">
          <span class="at-symbol">@</span>
        </div>

        <!-- Home Team (Right) -->
        <div class="team home-team">
          <div class="team-projection">
            <div class="projection-label">Proj</div>
            <div class="projection-value">{matchup.home.projection.toFixed(1)}</div>
          </div>
          <div class="team-info">
            <div class="team-name">{matchup.home.name}</div>
            <div class="team-record">
              <span class="seed">#{matchup.home.seed} Seed</span>
              <span class="separator">‚Ä¢</span>
              <span class="record">{matchup.home.record}</span>
            </div>
          </div>
          <div class="team-icon-container">
            <img
              src={`/assets/theleague/icons/${matchup.home.id}.png`}
              alt={matchup.home.name}
              class="team-icon"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Sunday Ticket Multi-View -->
    <SundayTicketMultiView 
      games={nflGamesForMultiView}
      timeSlot="both"
      maxGames={4}
      showTabs={true}
    />

    <!-- NFL Game Schedule -->
    {matchup.nflGames && matchup.nflGames.length > 0 && (
      <div class="nfl-games-section">
        <h3 class="section-title">NFL Schedule - Week {matchup.week}</h3>
        <p class="section-subtitle">Games ordered by player involvement from both teams</p>
        <div class="games-list">
          {matchup.nflGames.map((game: any) => (
            <div class="game-card">
              <div class="game-header">
                <div class="game-teams">
                  <img
                    src={getNFLTeamLogo(game.team1)}
                    alt={game.team1}
                    class="nfl-team-logo-large"
                    onerror="this.style.display='none'"
                  />
                  <span class="team-code">{game.team1}</span>
                  <span class="vs-text">@</span>
                  <span class="team-code">{game.team2}</span>
                  <img
                    src={getNFLTeamLogo(game.team2)}
                    alt={game.team2}
                    class="nfl-team-logo-large"
                    onerror="this.style.display='none'"
                  />
                </div>
                <div class="player-count-badge">
                  {game.playerCount} {game.playerCount === 1 ? 'player' : 'players'}
                </div>
              </div>
              <div class="game-details">
                <div class="game-detail-item">
                  <span class="detail-icon">üïê</span>
                  <span class="detail-text">{game.day} <span class="game-time-display" data-time-pt={game.time} data-day={game.day}>{game.time}</span></span>
                </div>
                <div class="game-detail-item" data-us-channel={game.channel}>
                  {game.channelLogo ? (
                    <div class="network-logo-wrapper">
                      <img
                        src={`/assets/tv-logos/${game.channelLogo}`}
                        alt={game.channel}
                        class={`network-logo ${game.channel.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}`}
                      />
                      <span class="tooltip channel-text">{game.channel}</span>
                    </div>
                  ) : (
                    <span class="detail-icon channel-text" title={game.channel}>üì∫ {game.channel}</span>
                  )}
                </div>
                {(game.stadium || getStadiumName(game.team2)) && (
                  <div class="game-detail-item">
                    <span class="detail-icon">üèüÔ∏è</span>
                    <span class="detail-text">{game.stadium || getStadiumName(game.team2)}</span>
                  </div>
                )}
                {game.weather && game.weather !== 'Unknown' && (
                  <div class="game-detail-item">
                    <span class="detail-icon">{game.weather}</span>
                    <span class="detail-text">
                      <span class="temperature-display" data-temp-f={game.temp}>{game.temp}</span> ¬∑ {game.conditions}
                    </span>
                  </div>
                )}
              </div>
              <div class="game-players">
                {game.players.map((player: any) => {
                  const matchupData = getPlayerMatchupData(player.name, matchup.nflMatchups);
                  const matchupQuality = matchupData?.isGoodMatchup ? 'favorable' : matchupData?.isToughMatchup ? 'tough' : 'neutral';
                  return (
                  <div class={`game-player ${matchupQuality}`}>
                    <img
                      src={getPlayerHeadshot(player.espnId)}
                      alt={player.name}
                      class="player-headshot-small"
                      onerror="this.src='https://www49.myfantasyleague.com/player_photos_2010/no_photo_available.jpg'"
                    />
                    <div class="player-info-wrapper">
                      <div class="player-header">
                        <div class="player-text">
                          <strong>{player.name}</strong> ({player.position}, {player.nflTeam})
                          {matchupData && (
                            <span class="player-matchup-info">
                              vs {matchupData.opponent} (#{matchupData.defenseRank} vs {matchupData.position})
                            </span>
                          )}
                        </div>
                        <div class="player-points">
                            
                        
                        
                      
                          {matchupData && (
                            <span class={`matchup-indicator-inline ${matchupData.isGoodMatchup ? 'good' : matchupData.isToughMatchup ? 'tough' : ''}`}>
                              {matchupData.isGoodMatchup ? '‚úì' : matchupData.isToughMatchup ? '‚ö†' : ''}
                            </span>
                          )}
                          Proj: <strong>{player.projectedPoints ?? '--'}</strong><img src={`/assets/theleague/icons/${player.fantasyTeamId}.png`} alt="Fantasy Team" class="fantasy-team-logo-tiny" onerror="this.style.display='none'" />
                        </div>
                      </div>

                    </div>
                  </div>
                )})}

              </div>
              {(() => {
                const blurb = getGameBlurb(game.team1, game.team2);
                return blurb ? (
                  <div class="game-blurb">
                    <div class="blurb-content">
                      <div class="blurb-label">Matchup Analysis</div>
                      <div class="blurb-text">{blurb.blurb}</div>
                    </div>
                  </div>
                ) : null;
              })()}
            </div>
          ))}
        </div>
      </div>
    )}
  </div>

  <script is:inline define:vars={{ currentMatchup, allMatchups, week }}>
    // Initialize matchup state management
    document.addEventListener('DOMContentLoaded', function() {
      // Handle matchup change events from the MatchupSelector
      document.addEventListener('matchupchange', function(event) {
        const { matchupId } = event.detail;
        if (matchupId) {
          // Update URL and reload page with new matchup
          const url = new URL(window.location.href);
          url.searchParams.set('matchup', matchupId);
          url.searchParams.set('week', week.toString());
          window.location.href = url.toString();
        }
      });

      // Handle browser back/forward navigation
      window.addEventListener('popstate', function() {
        // Reload page to reflect URL changes
        window.location.reload();
      });
    });
  </script>

  <script is:inline define:vars={{ broadcastMappings }}>
    // Convert all game times from PT to user's local timezone and handle international broadcasts
    function convertTimesToLocalTimezone() {
      const userTimezoneShort = new Date().toLocaleTimeString('en-us', {
        timeZoneName: 'short'
      }).split(' ')[2];

      // Convert PT time string to user's local time
      function convertPTTimeToLocal(ptTimeString) {
        // Parse time like "10:00 AM PST" or "1:25 PM PST"
        const match = ptTimeString.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!match) return ptTimeString;

        let [_, hours, minutes, period] = match;
        hours = parseInt(hours);
        minutes = parseInt(minutes);

        // Convert to 24-hour format
        if (period.toUpperCase() === 'PM' && hours !== 12) hours += 12;
        if (period.toUpperCase() === 'AM' && hours === 12) hours = 0;

        // Use next Sunday as the reference date for games
        const today = new Date();
        const daysUntilSunday = (7 - today.getDay()) % 7;
        const nextSunday = new Date(today);
        nextSunday.setDate(today.getDate() + daysUntilSunday);

        // Create date string for PT time
        const ptDateString = `${nextSunday.getFullYear()}-${String(nextSunday.getMonth() + 1).padStart(2, '0')}-${String(nextSunday.getDate()).padStart(2, '0')}T${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;

        // Parse as PT time and convert to local
        const ptDate = new Date(ptDateString + '-08:00'); // PT is UTC-8 (PST)

        // Format in user's timezone
        const localTimeString = ptDate.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        return `${localTimeString} ${userTimezoneShort}`;
      }

      // Update all game time displays
      document.querySelectorAll('.game-time-display').forEach(function(el) {
        const ptTime = el.getAttribute('data-time-pt');
        if (ptTime) {
          el.textContent = convertPTTimeToLocal(ptTime);
        }
      });

      // Update Sunday Ticket subtitle with local time
      const subtitles = document.querySelectorAll('[id^="sunday-ticket-subtitle"]');
      subtitles.forEach(subtitle => {
        const localTime = convertPTTimeToLocal('10:00 AM PST');
        const timeOnly = localTime.split(' ')[0]; // Get just "10:00" part
        const currentText = subtitle.textContent || '';
        if (currentText.includes('Top 4') || currentText.includes('Top')) {
          const gameCount = currentText.match(/Top (\d+)/)?.[1] || '4';
          subtitle.textContent = `Top ${gameCount} games ranked by fantasy impact for your ${timeOnly} quad-box`;
        }
      });
    }

    // Handle international broadcasts
    function updateBroadcastInfo() {
      // Check for query string override first
      const urlParams = new URLSearchParams(window.location.search);
      const countryParam = urlParams.get('country');

      let countryCode = 'US'; // default

      if (countryParam) {
        // Use query string override (e.g., ?country=CA or ?country=AU)
        countryCode = countryParam.toUpperCase();
        console.log(`üåç Using query string country override: ${countryCode}`);
      } else {
        // Detect country from timezone
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        // Simple timezone-based country detection
        if (timezone.includes('Toronto') || timezone.includes('Vancouver') || timezone.includes('Montreal') || timezone.includes('Edmonton')) {
          countryCode = 'CA';
        } else if (timezone.includes('Sydney') || timezone.includes('Melbourne') || timezone.includes('Brisbane')) {
          countryCode = 'AU';
        }
      }

      // Get country-specific mappings
      const countryData = broadcastMappings.countries[countryCode];
      if (!countryData) return;

      // Update all broadcast displays
      document.querySelectorAll('[data-us-channel]').forEach(function(el) {
        const usChannel = el.getAttribute('data-us-channel');

        if (countryCode === 'US') {
          // Keep US channel as-is
          return;
        }

        // Map to international channel
        const internationalChannel = countryData.mapping[usChannel] || countryData.mapping.default;
        const channelInfo = countryData.channels[internationalChannel];

        if (channelInfo) {
          // Update channel text
          const channelText = el.querySelector('.channel-text');
          if (channelText) {
            channelText.textContent = channelInfo.name;
          }

          // Update channel logo if present
          const channelImg = el.querySelector('.network-logo');
          if (channelImg && channelInfo.logo) {
            channelImg.src = '/assets/tv-logos/' + channelInfo.logo;
            channelImg.alt = channelInfo.name;
          }
        }
      });

      // Convert temperatures to Celsius for CA/AU
      if (countryCode === 'CA' || countryCode === 'AU') {
        convertTemperaturesToCelsius();
      }

      // Show country indicator
      console.log(`üì∫ Showing broadcasts for: ${countryData.name} (${countryCode})`);
    }

    // Convert Fahrenheit to Celsius
    function convertTemperaturesToCelsius() {
      document.querySelectorAll('.temperature-display').forEach(function(el) {
        const tempF = el.getAttribute('data-temp-f');
        if (!tempF) return;

        // Extract numeric value from string like "72¬∞F" or "10¬∞F"
        const match = tempF.match(/(\d+)¬∞F/);
        if (!match) return;

        const fahrenheit = parseInt(match[1]);
        const celsius = Math.round((fahrenheit - 32) * 5 / 9);

        // Update display with Celsius
        el.textContent = `${celsius}¬∞C`;
      });

      console.log('üå°Ô∏è Converted temperatures to Celsius');
    }

    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        convertTimesToLocalTimezone();
        updateBroadcastInfo();
      });
    } else {
      convertTimesToLocalTimezone();
      updateBroadcastInfo();
    }
  </script>
</TheLeagueLayout>

<style>
  .matchup-preview-container {
    position: relative;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* Scoreboard Header */
  .scoreboard-header {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .bracket-label {
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .week-label {
    text-align: center;
    color: white;
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .matchup-scoreboard {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  /* Team Styles */
  .team {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
  }

  .away-team {
    flex-direction: row;
  }

  .home-team {
    flex-direction: row-reverse;
  }

  .team-icon-container {
    flex-shrink: 0;
  }

  .team-icon {
    width: 64px;
    height: 64px;
    border-radius: 0.5rem;
    background: white;
    padding: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .team-info {
    flex: 1;
    min-width: 0;
  }

  .away-team .team-info {
    text-align: left;
  }

  .home-team .team-info {
    text-align: right;
  }

  .team-name {
    color: white;
    font-size: 1.125rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 0.25rem;
  }

  .team-record {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .home-team .team-record {
    justify-content: flex-end;
  }

  .seed {
    font-weight: 600;
  }

  .separator {
    opacity: 0.5;
  }

  .team-projection {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 0.5rem;
  }

  .projection-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .projection-value {
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
  }

  /* VS Divider */
  .vs-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .at-symbol {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.5rem;
    font-weight: 700;
  }

  

  .ai-icon {
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-link-default-text-color, #1c497c);
    margin: 0 0 1.5rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--primary-content-border-color, #e2e2e2);
  }

  .nfl-team-logo-large {
    width: 72px;
    height: 72px;
    object-fit: contain;
  }



  /* NFL Games Section */
  .nfl-games-section {
    background: var(--content-bg, #fff);
    border-radius: 1rem;
    padding: 2rem;
    margin-top: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .section-subtitle {
    font-size: 0.875rem;
    color: var(--muted-text-color, #6b7280);
    margin: -0.75rem 0 1.5rem 0;
  }

  .games-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .game-card {
    border-radius: 0.75rem;
    background: var(--content-bg, #fff);
    transition: box-shadow 0.2s;
  }
  @media screen and (min-width: 500px) {
    
  
    .game-card {
    border: 1px solid #cccccc;
      padding: 1rem;
  }
}
  .game-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--primary-content-border-color, #e2e2e2);
  }

  .game-details {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 0.5rem;
    flex-wrap: wrap;
  }

  .game-detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .game-blurb {
    padding: 0.875rem 1rem;
    margin-top: 0.75rem;
    border-top: 1px solid var(--primary-content-border-color, #e2e2e2);
    background: rgba(0, 0, 0, 0.01);
  }

  .blurb-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .blurb-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted-text-color, #6b7280);
  }

  .blurb-text {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--text-color, #1f2937);
    font-weight: 400;
  }

  .detail-icon {
    font-size: 1.125rem;
  }

  .network-logo-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
  }

  .network-logo {
    height: 1.5rem;
    width: auto;
    object-fit: contain;
    cursor: help;
  }
  .network-logo.ESPN {
    height: .9rem;
  }

  .tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    padding: 0.375rem 0.625rem;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    border-radius: 0.375rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
    z-index: 100;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
  }

  .network-logo-wrapper:hover .tooltip {
    opacity: 1;
    visibility: visible;
  }

  .detail-text {
    color: var(--text-color, #1f2937);
    font-weight: 500;
  }

  .game-teams {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
  }

 

  .team-code {
    font-size: 1rem;
    color: var(--text-color, #1f2937);
  }

  .vs-text {
    font-size: 0.875rem;
    color: var(--muted-text-color, #6b7280);
    font-weight: 500;
  }

  .player-count-badge {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .game-players {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .game-player {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    background: rgba(0, 0, 0, 0.02);
    border-left: 3px solid transparent;
    transition: all 0.2s;
  }

  .game-player.favorable {
    background: rgba(16, 185, 129, 0.08);
    border-left-color: #10b981;
  }

  .game-player.tough {
    background: rgba(239, 68, 68, 0.08);
    border-left-color: #ef4444;
  }

  .player-headshot-small {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 0.375rem;
    background: #f3f4f6;
  }

  .player-info-wrapper {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .player-points {
    font-size: 0.875rem;
    color: var(--text-color, #1f2937);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.25rem
  }

  .player-fantasy-meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: var(--muted-text-color, #6b7280);
  }

  .fantasy-team-logo-tiny {
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 2px;
    object-fit: contain;
  }

  .player-text {
    font-size: 0.875rem;
    color: var(--text-color, #1f2937);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .player-text strong {
    font-weight: 600;
  }

  .player-matchup-info {
    font-size: 0.75rem;
    color: var(--muted-text-color, #6b7280);
    font-weight: 500;
    line-height: 1.3;
  }

  .matchup-indicator-inline {
    font-size: 0.875rem;
    margin-right: 0.375rem;
  }

  .matchup-indicator-inline.good {
    color: #059669;
  }

  .matchup-indicator-inline.tough {
    color: #dc2626;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .matchup-scoreboard {
      flex-direction: column;
      gap: 0.75rem;
    }

    .team {
      width: 100%;
    }

    .home-team {
      flex-direction: row;
    }

    .home-team .team-info {
      text-align: left;
    }

    .home-team .team-record {
      justify-content: flex-start;
    }

    .vs-divider {
      width: 100%;
      padding: 0.5rem 0;
    }

    .team-icon {
      width: 56px;
      height: 56px;
    }

    .team-name {
      font-size: 1rem;
    }

    .projection-value {
      font-size: 1.25rem;
    }

    .story-content {
      padding: 1.5rem;
    }

    .story-title {
      font-size: 1.25rem;
    }

    .nfl-team-logo-large {
      width: 60px;
      height: 60px;
    }

    .game-header {
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .game-teams {
      flex-wrap: wrap;
    }

    .nfl-games-section {
      padding: 1.5rem;
    }
  }
</style>
