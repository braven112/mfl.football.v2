---
import TheLeagueLayout from '../../layouts/TheLeagueLayout.astro';
import leagueAssets from '../../data/theleague.assets.json';
import { DEFAULT_HEADSHOT_URL, getPlayerImageUrl } from '../../constants/roster-constants';

const playerModules = import.meta.glob(
  '../../data/mfl-player-salaries-*.json',
  { eager: true }
);

const getModuleData = (mod) =>
  mod && typeof mod === 'object' && 'default' in mod ? mod.default : mod;

const extractSeason = (filepath) => {
  const match = filepath.match(/(\d{4})\.json$/);
  return match ? match[1] : null;
};

const positionLabels = [
  { key: 'QB', label: 'Quarterback' },
  { key: 'RB', label: 'Running Back' },
  { key: 'WR', label: 'Wide Receiver' },
  { key: 'TE', label: 'Tight End' },
  { key: 'PK', label: 'Kicker' },
  { key: 'Def', label: 'Defense/ST' },
];
const positionLabelMap = new Map(
  positionLabels.map(({ key, label }) => [key, label])
);

const franchiseLookup = new Map(
  (leagueAssets.teams ?? []).map((team) => [
    team.id,
    {
      name: team.name,
      icon: team.assets?.icons?.[0]?.relativePath,
    },
  ])
);

/** @type {Array<{
  season: string,
  id: string,
  name: string,
  position: string,
  salary: number,
  points: number,
  efficiency: number,
  franchiseId?: string,
  team?: string,
  positionLabel?: string,
  headshot?: string
}>} */
const overallCandidates: Array<{
  season: string,
  id: string,
  name: string,
  position: string,
  salary: number,
  points: number,
  efficiency: number,
  franchiseId?: string,
  team?: string,
  positionLabel?: string,
  headshot?: string
}> = [];
const positionBuckets = new Map<string, Array<{
  season: string,
  id: string,
  name: string,
  position: string,
  salary: number,
  points: number,
  efficiency: number,
  franchiseId?: string,
  team?: string,
  positionLabel?: string,
  headshot?: string
}>>(positionLabels.map(({ key }) => [key, []]));
Object.entries(playerModules).forEach(([path, mod]) => {
  const season = extractSeason(path);
  if (!season) return;

  const data = getModuleData(mod);
  const players = data?.players ?? [];
  const seasonCandidates = players
    .map((player) => {
      const salary = Number(player.salary) || 0;
      const points = Number(player.points) || 0;
      if (!salary || !points) return null;
      return {
        season,
        id: player.id,
        name: player.name,
        position: player.position,
        salary,
        points,
        efficiency: points / salary,
        franchiseId: player.franchiseId,
        team: player.team ?? '',
        headshot: player.headshot ?? getPlayerImageUrl(player.id),
      };
    })
    .filter(Boolean);

  if (!seasonCandidates.length) return;
  seasonCandidates.sort((a, b) => b.efficiency - a.efficiency);
  const overall = seasonCandidates[0];
  if (overall) {
    overallCandidates.push({
      ...overall,
      positionLabel: positionLabelMap.get(overall.position) ?? overall.position,
    });
  }

  const positionLeaders = new Map();
  seasonCandidates.forEach((candidate) => {
    const existing = positionLeaders.get(candidate.position);
    if (!existing || candidate.efficiency > existing.efficiency) {
      positionLeaders.set(candidate.position, candidate);
    }
  });
  positionLeaders.forEach((value, posKey) => {
    const entry = {
      ...value,
      positionLabel: positionLabelMap.get(posKey) ?? posKey,
    };
    const bucket = positionBuckets.get(posKey);
    if (bucket) bucket.push(entry);
  });
});

overallCandidates.sort((a, b) => Number(b.season) - Number(a.season));

// Sort each position bucket by season (newest first)
positionBuckets.forEach((bucket) => {
  bucket.sort((a, b) => Number(b.season) - Number(a.season));
});

// Create a set of overall MVP player IDs for badge display
const overallMvpIds = new Set(overallCandidates.map(p => `${p.id}-${p.season}`));

// Get available positions for filter
const availablePositions = [...positionLabels];
const currencyFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});
const formatCurrency = (value) => {
  if (!Number.isFinite(value)) return '$0';
  return currencyFormatter.format(Math.round(value));
};
const formatPoints = (value) =>
  Number.isFinite(value) ? value.toFixed(1) : '0.0';
const getNflLogo = (team) => {
  let code = (team ?? '').toUpperCase() || 'FA';
  // Normalize team codes that don't match logo filenames
  const teamCodeMap: Record<string, string> = {
    'TBB': 'TB',  // Tampa Bay Buccaneers
    'GBP': 'GB',  // Green Bay Packers
    'NEP': 'NE',  // New England Patriots
    'KCC': 'KC',  // Kansas City Chiefs
    'SFO': 'SF',  // San Francisco 49ers
    'NOS': 'NO',  // New Orleans Saints
    'SDC': 'SD',  // San Diego Chargers (historical)
    'JAC': 'JAX', // Jacksonville Jaguars
  };
  code = teamCodeMap[code] ?? code;
  return `/assets/nfl-logos/${code}.svg`;
};
---

<TheLeagueLayout title="MFL MVPs">
  <section class="mvp-history">
    <header>
      <h1>Salary-Adjusted MVP History</h1>
      <p>
        Most efficient contracts by season, calculated as points scored divided
        by salary. Data refreshes whenever new salary snapshots are generated.
      </p>
    </header>

    <div class="filters">
      <div class="filter-group">
        <label for="position-filter" class="filter-label">Position</label>
        <select id="position-filter" class="filter-select">
          <option value="all">All Positions</option>
          {availablePositions.map(({ key, label }) => (
            <option value={key}>{label}</option>
          ))}
        </select>
      </div>
    </div>

    <div class="mvp-grid" id="overall-mvp-grid">
      {overallCandidates.length ? (
        overallCandidates.map((player) => {
          const franchise = player.franchiseId
            ? franchiseLookup.get(player.franchiseId)
            : null;
          const nflLogo = player.team ? getNflLogo(player.team) : null;
          return (
            <article class="mvp-card" data-year={player.season} data-position={player.position}>
              <header>
                <div class="card-header-top">
                  <p class="mvp-season">{player.season}</p>
                  {franchise?.icon && (
                    <img
                      src={franchise.icon}
                      alt={franchise?.name ?? 'Franchise'}
                      class="franchise-icon"
                      loading="lazy"
                    />
                  )}
                </div>
                <div class="player-info">
                  <img
                    src={player.headshot ?? DEFAULT_HEADSHOT_URL}
                    alt={`${player.name} headshot`}
                    class="player-headshot"
                    loading="lazy"
                    onerror={`this.onerror=null;this.src='${DEFAULT_HEADSHOT_URL}';`}
                  />
                  <div>
                    <h2>{player.name}</h2>
                    <p class="mvp-meta">
                      {nflLogo && (
                        <img
                          src={nflLogo}
                          alt={`${player.team ?? 'FA'} logo`}
                          class="nfl-icon"
                          loading="lazy"
                        />
                      )}
                      <span>{player.position}</span>
                    </p>
                  </div>
                </div>
              </header>
              <dl>
                <div>
                  <dt>Points</dt>
                  <dd>{formatPoints(player.points)}</dd>
                </div>
                <div>
                  <dt>Salary</dt>
                  <dd>{formatCurrency(player.salary)}</dd>
                </div>
                <div>
                  <dt>Efficiency</dt>
                  <dd>{formatCurrency(1 / player.efficiency)} / pt</dd>
                </div>
              </dl>
            </article>
          );
        })
      ) : (
        <p>No MVP data available yet.</p>
      )}
    </div>
    <section class="position-mvps">
      <h2>Position MVPs</h2>
      {positionLabels.map(({ key, label }) => {
        const list = positionBuckets.get(key) ?? [];
        return (
          <div class="position-group">
            <h3>{label}</h3>
            <div class="mvp-grid">
              {list.length ? (
                list.map((player) => {
                  const franchise = player.franchiseId
                    ? franchiseLookup.get(player.franchiseId)
                    : null;
                  const nflLogo = player.team ? getNflLogo(player.team) : null;
                  const isLeagueMvp = overallMvpIds.has(`${player.id}-${player.season}`);
                  return (
                    <article class="mvp-card" data-year={player.season} data-position={player.position}>
                      <header>
                        <div class="card-header-top">
                          <div class="season-badge-row">
                            <p class="mvp-season">{player.season}</p>
                            {isLeagueMvp && (
                              <span class="league-mvp-badge">League MVP</span>
                            )}
                          </div>
                          {franchise?.icon && (
                            <img
                              src={franchise.icon}
                              alt={franchise?.name ?? 'Franchise'}
                              class="franchise-icon"
                              loading="lazy"
                            />
                          )}
                        </div>
                        <div class="player-info">
                          <img
                            src={player.headshot ?? DEFAULT_HEADSHOT_URL}
                            alt={`${player.name} headshot`}
                            class="player-headshot"
                            loading="lazy"
                            onerror={`this.onerror=null;this.src='${DEFAULT_HEADSHOT_URL}';`}
                          />
                          <div>
                            <h2>{player.name}</h2>
                            <p class="mvp-meta">
                              {nflLogo && (
                                <img
                                  src={nflLogo}
                                  alt={`${player.team ?? 'FA'} logo`}
                                  class="nfl-icon"
                                  loading="lazy"
                                />
                              )}
                              <span>{player.position}</span>
                            </p>
                          </div>
                        </div>
                      </header>
                      <dl>
                        <div>
                          <dt>Points</dt>
                          <dd>{formatPoints(player.points)}</dd>
                        </div>
                        <div>
                          <dt>Salary</dt>
                          <dd>{formatCurrency(player.salary)}</dd>
                        </div>
                        <div>
                          <dt>Efficiency</dt>
                          <dd>{formatCurrency(1 / player.efficiency)} / pt</dd>
                        </div>
                      </dl>
                    </article>
                  );
                })
              ) : (
                <p class="empty-state">No MVP data yet.</p>
              )}
            </div>
          </div>
        );
      })}
    </section>
  </section>
</TheLeagueLayout>

<style>
  .mvp-history {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .filters {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 1.25rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #475569;
    margin: 0;
  }

  .filter-select {
    padding: 0.625rem 0.875rem;
    border: 2px solid #cbd5e1;
    border-radius: 0.5rem;
    background-color: #fff;
    color: #1e293b;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    width: fit-content;
  }

  .filter-select:hover {
    border-color: #94a3b8;
  }

  .filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mvp-card.hidden {
    display: none;
  }

  .season-badge-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .league-mvp-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    border-radius: 0.375rem;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  .mvp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(330px, 1fr));
    gap: 1.5rem;
  }

  .mvp-card {
    background: #fff;
    border: 1px solid #d7dce3;
    border-radius: 1rem;
    padding: 1.25rem;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .mvp-card header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .card-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }

  .franchise-icon {
    width: 48px;
    height: 48px;
    border-radius: 0.5rem;
    object-fit: contain;
  }

  .player-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
  }

  .player-headshot {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    background: #f3f4f6;
    flex-shrink: 0;
  }

  .mvp-season {
    margin: 0;
    font-weight: 600;
    color: #6b7280;
  }

  .mvp-meta {
    margin: 0;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    flex-wrap: wrap;
  }

  .nfl-icon {
    width: 28px;
    height: 28px;
    object-fit: contain;
  }

  dl {
    margin: 0;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.85rem;
  }

  dt {
    font-size: 0.85rem;
    text-transform: uppercase;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  dd {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .position-mvps h2 {
    margin-bottom: 0.5rem;
  }

  .position-group {
    margin-bottom: 2rem;
  }

  .position-group:last-child {
    margin-bottom: 0;
  }

  .empty-state {
    margin: 0;
    color: #6b7280;
  }
</style>

<script>
  function setupMvpFilters() {
    const positionFilter = document.getElementById('position-filter') as HTMLSelectElement;
    const overallGrid = document.getElementById('overall-mvp-grid');
    const positionGroups = document.querySelectorAll('.position-group');

    function applyFilters() {
      const selectedPosition = positionFilter.value;

      // When a position is selected, hide the overall MVP grid
      if (overallGrid) {
        if (selectedPosition === 'all') {
          overallGrid.style.display = '';
        } else {
          overallGrid.style.display = 'none';
        }
      }

      // Show only the selected position group, or all groups if "All Positions"
      positionGroups.forEach((group) => {
        const groupHeading = group.querySelector('h3');
        const groupPosition = groupHeading?.textContent?.trim();

        if (selectedPosition === 'all') {
          (group as HTMLElement).style.display = '';
        } else {
          // Map position keys to labels for comparison
          const positionMap: Record<string, string> = {
            'QB': 'Quarterback',
            'RB': 'Running Back',
            'WR': 'Wide Receiver',
            'TE': 'Tight End',
            'PK': 'Kicker',
            'Def': 'Defense/ST'
          };

          const selectedLabel = positionMap[selectedPosition];
          if (groupPosition === selectedLabel) {
            (group as HTMLElement).style.display = '';
          } else {
            (group as HTMLElement).style.display = 'none';
          }
        }
      });
    }

    positionFilter?.addEventListener('change', applyFilters);
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMvpFilters);
  } else {
    setupMvpFilters();
  }

  // Re-run on page transitions (for Astro view transitions)
  document.addEventListener('astro:after-swap', setupMvpFilters);
</script>
