---
/**
 * My Team Widget - Hover Dropdown with league management links (AFL Fantasy)
 * Default: Shows team logo only
 * On Hover: Expands to show 6 quick management links
 */

import { getAFLPreference, resolveAFLTeamSelection, getAFLTeamData } from '../../utils/team-preferences';
import { getLeagueContext } from '../../utils/league-context';
import aflAssets from '../../../data/afl-fantasy/afl.assets.json';

// Get user's preferred team using the same resolution logic as other AFL pages
const cookiePreference = getAFLPreference(Astro.cookies);

// Resolve team selection with fallback to first team (0001)
const preferredTeamId = resolveAFLTeamSelection({
  cookiePreference: cookiePreference?.franchiseId,
  defaultTeam: '0001',
});

// Debug logging
console.log('[MyTeamWidget AFL] Cookie:', cookiePreference);
console.log('[MyTeamWidget AFL] Resolved team ID:', preferredTeamId);

// Load current year data - use environment variable for current season year
const currentYear = parseInt(import.meta.env.PUBLIC_MFL_YEAR || new Date().getFullYear().toString(), 10);
const league = getLeagueContext(Astro.url);

// Get team icon
const teamAsset = aflAssets.teams.find(t => t.id === preferredTeamId);
const teamIcon = teamAsset?.assets?.icons?.[0]?.relativePath;
const teamName = teamAsset?.name || '';

console.log('[MyTeamWidget AFL] Team asset:', teamAsset?.name, 'Icon:', teamIcon);

// Don't render if no team asset found
if (!teamAsset || !teamIcon) {
  return null;
}

// Construct MFL management URLs
const year = currentYear.toString();
const submitLineupUrl = `https://${league.host}/${year}/lineup?L=${league.leagueId}`;
const addDropUrl = `https://${league.host}/${year}/add_drop?L=${league.leagueId}`;
const injuredReserveUrl = `https://${league.host}/${year}/options?L=${league.leagueId}&O=18`;
const tradeBlockUrl = `https://${league.host}/${year}/options?L=${league.leagueId}&O=133`;
const tradesUrl = `https://${league.host}/${year}/options?L=${league.leagueId}&O=05`;
---

<div class="my-team-dropdown" data-franchise-id={preferredTeamId}>
  <button class="team-trigger" id="team-trigger-btn" aria-label="Team management links">
    <img src={teamIcon} alt={teamName} class="team-icon" />
  </button>

  <!-- Desktop hover dropdown -->
  <div class="team-dropdown-content">
    <div class="team-actions">
      <a href={submitLineupUrl} class="action-link">→ Submit Lineup</a>
      <a href={addDropUrl} class="action-link">→ Add/Drops</a>
      <a href={injuredReserveUrl} class="action-link">→ Injured Reserve</a>
      <a href={tradeBlockUrl} class="action-link">→ Trade Block</a>
      <a href={tradesUrl} class="action-link">→ Trades</a>
    </div>
  </div>
</div>

<script>
  // Mobile click handler - opens slide-in menu
  // Desktop uses hover (CSS only)
  const teamTriggerBtn = document.getElementById('team-trigger-btn');

  teamTriggerBtn?.addEventListener('click', () => {
    // Only trigger on mobile/tablet (where slide-in is used)
    if (window.innerWidth <= 980) {
      (window as any).toggleTeamMenu?.();
    }
  });
</script>

<style>
  .my-team-dropdown {
    position: relative;
    display: inline-block;
  }

  .team-trigger {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.75rem;
    height: 2.75rem;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    padding: 0.375rem;
    transition: all 0.2s ease;
  }

  .team-trigger:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-1px);
  }

  .team-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .team-dropdown-content {
    position: absolute;
    top: calc(100% + 0.75rem);
    right: 0;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
    min-width: 280px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    pointer-events: none;
  }

  /* Invisible bridge to keep hover state */
  .team-dropdown-content::before {
    content: '';
    position: absolute;
    bottom: 100%;
    right: 0;
    width: 100%;
    height: 1rem;
    background: transparent;
  }

  .my-team-dropdown:hover .team-dropdown-content,
  .team-dropdown-content:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .team-actions {
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .action-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #333;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f5f5f5;
    transition: color 0.2s ease;
  }

  .action-link:hover {
    color: var(--secondary-color, #2e8743);
  }

  /* Hide hover dropdown on mobile - use slide-in panel instead */
  @media (max-width: 980px) {
    .team-dropdown-content {
      display: none;
    }

    .team-trigger {
      cursor: pointer;
    }
  }
</style>
