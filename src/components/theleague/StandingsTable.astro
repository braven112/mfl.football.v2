---
import type { TeamStanding } from '../../types/standings';
import PlayoffBadge from './PlayoffBadge.astro';

export interface Props {
  teams: TeamStanding[];
  view: 'division' | 'league' | 'all_play';
  showDivisionHeader?: boolean;
  divisionName?: string;
}

const { teams, view, showDivisionHeader = false, divisionName = '' } = Astro.props;

function parseWLT(wlt: string) {
  const [w, l, t] = wlt.split('-').map(Number);
  return { w, l, t };
}

function getPlayoffStatus(team: TeamStanding): 'division_winner' | 'wild_card' | null {
  if (team.seed && team.seed <= 4) return 'division_winner';
  if (team.seed && team.seed >= 5 && team.seed <= 7) return 'wild_card';
  return null;
}

function calculateGamesBack(team: TeamStanding, allTeamsInDivision: TeamStanding[]): number {
  if (allTeamsInDivision.length === 0) return 0;

  // Find the team with the best record
  const best = allTeamsInDivision.reduce((prev, current) => {
    const prevWins = parseInt(prev.divw);
    const currentWins = parseInt(current.divw);
    return currentWins > prevWins ? current : prev;
  });

  const bestWins = parseInt(best.divw);
  const bestLosses = parseInt(best.divl);
  const teamWins = parseInt(team.divw);
  const teamLosses = parseInt(team.divl);

  return ((bestWins - teamWins) + (teamLosses - bestLosses)) / 2;
}
---

<div class="standings-container">
  {showDivisionHeader && divisionName && (
    <h3 class="division-header">{divisionName}</h3>
  )}

  <div class="table-wrapper">
    <table class="standings-table">
      <thead>
        <tr>
          {view === 'league' && <th class="col-seed">Seed</th>}
          {(view === 'division' || view === 'all_play') && <th class="col-badge">Badge</th>}
          <th class="col-team">Team</th>
          {view === 'division' && <th class="col-record">Record</th>}
          {view === 'division' && <th class="col-pct">PCT</th>}
          {view === 'division' && <th class="col-gb">GB</th>}
          {view === 'division' && <th class="col-streak">Streak</th>}
          {view === 'division' && <th class="col-div-record">Div Record</th>}
          {view !== 'division' && <th class="col-record">Record</th>}
          {view !== 'division' && <th class="col-pct">PCT</th>}
          {view !== 'division' && <th class="col-pf">PF</th>}
          {view !== 'division' && <th class="col-pa">PA</th>}
          {view !== 'division' && <th class="col-pwr">PWR</th>}
          {view !== 'division' && <th class="col-vp">VP</th>}
        </tr>
      </thead>
      <tbody>
        {teams.map((team, index) => {
          const record = view === 'all_play'
            ? parseWLT(team.all_play_wlt)
            : parseWLT(team.divwlt);

          const pct = view === 'all_play'
            ? team.all_play_pct
            : team.divpct;

          const playoffStatus = getPlayoffStatus(team);
          const gamesBack = view === 'division' ? calculateGamesBack(team, teams) : 0;

          return (
            <tr key={team.id} class={`row-${index % 2 === 0 ? 'even' : 'odd'}`}>
              {view === 'league' && (
                <td class="col-seed">
                  <span class="seed-badge">#{team.seed}</span>
                </td>
              )}
              {(view === 'division' || view === 'all_play') && (
                <td class="col-badge">
                  <PlayoffBadge status={playoffStatus} seed={team.seed} />
                </td>
              )}
              <td class="col-team">
                <div class="team-info">
                  {team.teamBanner && (
                    <img
                      src={team.teamBanner}
                      alt={team.teamName}
                      class="team-banner"
                      title={team.teamName}
                    />
                  )}
                  <span class="team-name">{team.teamName}</span>
                </div>
              </td>
              {view === 'division' && (
                <>
                  <td class="col-record">
                    {record.w}-{record.l}-{record.t}
                  </td>
                  <td class="col-pct">
                    {parseFloat(team.divpct).toFixed(3)}
                  </td>
                  <td class="col-gb">
                    {gamesBack === 0 ? 'â€”' : gamesBack.toFixed(1)}
                  </td>
                  <td class="col-streak">
                    {team.strk}
                  </td>
                  <td class="col-div-record">
                    {record.w}-{record.l}
                  </td>
                </>
              )}
              {view !== 'division' && (
                <>
                  <td class="col-record">
                    {record.w}-{record.l}-{record.t}
                  </td>
                  <td class="col-pct">
                    {parseFloat(pct).toFixed(3)}
                  </td>
                  <td class="col-pf">
                    {parseFloat(team.pf).toFixed(1)}
                  </td>
                  <td class="col-pa">
                    {parseFloat(team.pa).toFixed(1)}
                  </td>
                  <td class="col-pwr">
                    {parseFloat(team.pwr).toFixed(1)}
                  </td>
                  <td class="col-vp">
                    {parseInt(team.vp)}
                  </td>
                </>
              )}
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</div>

<style>
  .standings-container {
    margin-bottom: 2rem;
    background-color: var(--primary-content-bg-color, #fff);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: var(--padding-md);
    overflow-x: auto;
  }

  .division-header {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--color-text-primary, #1a1a1a);
    padding-bottom: 0.5rem;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .standings-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--color-bg-secondary, #f5f5f5);
  }

  thead {
    background-color: var(--primary-content-bg-color, #fff);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--table-header-text-color, #94a3b8);
    border-bottom: 2px solid var(--color-border, #d0d0d0);
  }

  td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border, #e0e0e0);
    font-size: var(--table-cell-font-size, .75rem);

  }

  tbody tr {
    background-color: var(--color-bg-primary, #fff);
    transition: background-color 0.2s ease;
  }

  tbody tr:hover {
    background-color: var(--color-bg-hover, #f9f9f9);
  }

  tbody tr.row-odd {
    background-color: var(--color-bg-secondary, #f5f5f5);
  }

  tbody tr.row-odd:hover {
    background-color: var(--color-bg-hover, #efefef);
  }

  /* Column Widths */
  .col-seed {
    width: 70px;
    text-align: center;
    font-weight: 600;
  }

  .col-badge {
    width: 100px;
    text-align: center;
    padding: 0.75rem 0.5rem;
  }

  .col-team {
    width: auto;
    min-width: 200px;
  }

  .col-record {
    width: 100px;
    text-align: center;
    white-space: nowrap;
  }

  .col-pct {
    width: 90px;
    text-align: center;
  }

  .col-pf,
  .col-pa {
    width: 100px;
    text-align: right;
  }

  .col-pwr,
  .col-vp {
    width: 90px;
    text-align: center;
  }

  .col-ap-record,
  .col-div-record {
    width: 110px;
    text-align: center;
  }

  .col-h2h {
    width: 90px;
    text-align: center;
  }

  .col-gb {
    width: 80px;
    text-align: center;
  }

  .col-streak {
    width: 100px;
    text-align: center;
  }

  /* Team Info */
  .team-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .team-banner {
    width: 100%;
    max-width: 400px;
    height: auto;
    object-fit: contain;
  }

  .team-name {
    display: none;
  }

  .seed-badge {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--color-text-primary, #1a1a1a);
    background-color: var(--color-bg-tertiary, #e8e8e8);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    display: inline-block;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .col-team {
      min-width: 150px;
    }

    .col-pwr,
    .col-vp,
    .col-pct,
    .col-h2h,
    .col-gb,
    .col-streak {
      font-size: 0.8rem;
      padding: 0.5rem;
    }

    th {
      font-size: 0.75rem;
      padding: 0.5rem;
    }

    .team-banner {
      height: 24px;
      max-width: 100px;
    }

    .team-name {
      font-size: 0.9rem;
    }
  }
</style>
