---
/**
 * DonutChart - Reusable donut/pie chart component
 * Renders using CSS conic-gradient with optional legend
 */

import type { ChartSlice } from '../../scripts/chart-utils';

export interface Props {
  /** Array of chart slices to render */
  slices: ChartSlice[];
  /** Whether to show the legend */
  showLegend?: boolean;
  /** Chart diameter in pixels */
  size?: number;
  /** Unique ID for the chart element */
  chartId: string;
  /** Optional ID for the legend element */
  legendId?: string;
}

const {
  slices = [],
  showLegend = false,
  size = 150,
  chartId,
  legendId,
} = Astro.props;

// Generate unique IDs if not provided
const actualLegendId = legendId ?? `${chartId}-legend`;

// Serialize slices data to pass to client script
const serializedSlices = JSON.stringify(slices);
---

<div class="donut-chart-container" data-chart-id={chartId}>
  <div
    class="donut"
    id={chartId}
    data-slices={serializedSlices}
    style={`width: ${size}px; height: ${size}px;`}
  ></div>
  {showLegend && (
    <div class="chart-legend" id={actualLegendId}></div>
  )}
</div>

<script>
  import { buildDonut, renderLegend, type ChartSlice } from '../../scripts/chart-utils';

  // Find all donut charts and render them
  document.querySelectorAll<HTMLElement>('.donut').forEach((donutEl) => {
    const slicesJson = donutEl.dataset.slices;
    if (!slicesJson) return;

    try {
      const slices: ChartSlice[] = JSON.parse(slicesJson);
      const total = slices.reduce((sum, slice) => sum + slice.value, 0);

      // Render the donut chart
      buildDonut(donutEl, slices, total);

      // Render legend if it exists
      const chartId = donutEl.id;
      const legendEl = document.getElementById(`${chartId}-legend`);
      if (legendEl) {
        renderLegend(legendEl, slices);
      }
    } catch (error) {
      console.error('Failed to render donut chart:', error);
    }
  });
</script>

<style>
  .donut-chart-container {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    align-items: start;
    width: 100%;
  }

  /* When there's only one child (no legend), center the donut */
  .donut-chart-container:not(:has(.chart-legend)) {
    grid-template-columns: 1fr;
    justify-items: center;
  }

  .donut {
    border-radius: 50%;
    background: conic-gradient(#e2e8f0 0deg, #e2e8f0 360deg);
    position: relative;
    flex-shrink: 0;
  }

  /* Inner circle to create donut hole */
  .donut::after {
    content: '';
    position: absolute;
    top: 22px;
    left: 22px;
    right: 22px;
    bottom: 22px;
    background: var(--card-bg-color, #fff);
    border-radius: 50%;
  }

  .chart-legend {
    display: grid;
    gap: 0.5rem;
    font-size: 0.6rem;
    min-width: 0;
    align-self: start;
    justify-self: center;
  }

  :global(.chart-legend__item) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: space-between;
  }

  :global(.chart-legend__label) {
    display: flex;
    align-items: center;
    gap: 0..25rem;
    color: #111;
    font-weight: 500;
    font-size: 0.6rem;
  }

  :global(.chart-legend__label .legend-dot) {
    flex-shrink: 0;
    margin-right: 0.1rem;
  }

  :global(.legend-dot) {
    display: inline-block;
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 999px;
  }

  :global(.chart-legend__value) {
    color: #111;
    font-size: 0.6rem;
    font-weight: 300;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .donut {
      width: 120px !important;
      height: 120px !important;
    }

    .donut::after {
      top: 18px;
      left: 18px;
      right: 18px;
      bottom: 18px;
    }
  }
</style>
