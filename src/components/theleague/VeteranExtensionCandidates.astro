---
/**
 * VeteranExtensionCandidates - Displays potential veteran extension candidates
 * Shows players who could be extended based on performance and contract status
 * Players must be:
 * - Top 10 in points at their position OR top 7 in PPG
 * - Have 2-3 years remaining on their contract
 * - Have current salary under $2.5M
 */

import { currencyFormatter } from '../../utils/formatters';
import { calculateExtensionSalary } from '../../utils/extension-salary-calculator';
import leagueAssets from '../../data/theleague.assets.json';

export interface Props {
  players: Array<{
    id: string;
    name: string;
    position: string;
    salary: number;
    points: number;
    franchiseId: string;
    nflTeam: string;
    headshot: string;
    nflLogo: string;
    contractYears: number;
    gamesPlayed?: number;
  }>;
  salaryAverages?: Record<string, { [key: string]: number }>;
  season?: string;
  showTeamLogo?: boolean;
}

// NFL team code to full name mapping
const NFL_TEAM_NAMES: Record<string, string> = {
  ARI: 'Arizona', ATL: 'Atlanta', BAL: 'Baltimore', BUF: 'Buffalo',
  CAR: 'Carolina', CHI: 'Chicago', CIN: 'Cincinnati', CLE: 'Cleveland',
  DAL: 'Dallas', DEN: 'Denver', DET: 'Detroit', GB: 'Green Bay',
  HOU: 'Houston', IND: 'Indianapolis', JAC: 'Jacksonville', KC: 'Kansas City',
  LV: 'Las Vegas', LAC: 'Los Angeles', LAR: 'Los Angeles', MIA: 'Miami',
  MIN: 'Minnesota', NE: 'New England', NO: 'New Orleans', NYG: 'New York',
  NYJ: 'New York', PHI: 'Philadelphia', PIT: 'Pittsburgh', SEA: 'Seattle',
  SF: 'San Francisco', TB: 'Tampa Bay', TEN: 'Tennessee', WAS: 'Washington',
};

const { players = [], salaryAverages = {}, season = '2025', showTeamLogo = true } = Astro.props;
const seasonAverages = salaryAverages[season] ?? {};

const SALARY_THRESHOLD = 2_500_000; // $2.5 million

// Helper function to calculate PPG
const calculatePPG = (points: number, gamesPlayed: number | undefined): number => {
  if (!gamesPlayed || gamesPlayed === 0) return 0;
  return points / gamesPlayed;
};

// Filter to players meeting extension criteria
const positionOrder = ['QB', 'RB', 'WR', 'TE', 'PK', 'DEF'];

// First, rank ALL players by position and PPG
const playersByPosition = new Map<string, (typeof players)[number][]>();
players.forEach((player) => {
  const pos = player.position?.toUpperCase() || 'UNK';
  if (!playersByPosition.has(pos)) {
    playersByPosition.set(pos, []);
  }
  playersByPosition.get(pos)!.push(player);
});

// Sort each position by points and get rankings
const pointsRankings = new Map<string, number>(); // player id -> rank at position by points
playersByPosition.forEach((posPlayers, pos) => {
  posPlayers
    .sort((a, b) => (b.points ?? 0) - (a.points ?? 0))
    .forEach((player, idx) => {
      pointsRankings.set(player.id, idx + 1);
    });
});

// Calculate PPG rankings
const ppgRankings = new Map<string, number>(); // player id -> rank at position by PPG
playersByPosition.forEach((posPlayers, pos) => {
  const playersWithPPG = posPlayers
    .map(p => ({ ...p, ppg: calculatePPG(p.points ?? 0, p.gamesPlayed) }))
    .sort((a, b) => b.ppg - a.ppg);

  playersWithPPG.forEach((player, idx) => {
    ppgRankings.set(player.id, idx + 1);
  });
});

// Position-specific PPG thresholds
const ppgThresholds: Record<string, number> = {
  QB: 15,
  RB: 30,
  WR: 30,
  TE: 20,
  PK: 20,
  DEF: 15,
};

const getPpgThreshold = (position: string): number => {
  const pos = position?.toUpperCase() || 'UNK';
  return ppgThresholds[pos] ?? 20;
};

// Filter eligible players
const extensionCandidates: (typeof players[number] & { pointsRank: number; ppgRank: number; ppg: number })[] = [];
players.forEach((player) => {
  // Must have 2-3 years on contract
  if (player.contractYears !== 2 && player.contractYears !== 3) return;

  // Must be under salary threshold
  if ((player.salary ?? 0) >= SALARY_THRESHOLD) return;

  // Must have positive points
  if ((player.points ?? 0) <= 0) return;

  const ppg = calculatePPG(player.points ?? 0, player.gamesPlayed);
  const pointsRank = pointsRankings.get(player.id) || Infinity;
  const ppgRank = ppgRankings.get(player.id) || Infinity;
  const posThreshold = getPpgThreshold(player.position);

  // Must be top 20 by points OR position-specific threshold by PPG
  if (pointsRank <= 20 || ppgRank <= posThreshold) {
    extensionCandidates.push({
      ...player,
      pointsRank,
      ppgRank,
      ppg,
      position: player.position?.toUpperCase() || 'UNK'
    });
  }
});

// Sort by position order for display
extensionCandidates.sort((a, b) => {
  const posA = a.position?.toUpperCase() || 'UNK';
  const posB = b.position?.toUpperCase() || 'UNK';
  const posDiff = positionOrder.indexOf(posA) - positionOrder.indexOf(posB);
  if (posDiff !== 0) return posDiff;
  return (a.pointsRank ?? 0) - (b.pointsRank ?? 0);
});

const DEFAULT_HEADSHOT_URL = 'https://s.yimg.com/cv/apiv2/default/nfl/nophoto.png';

const getTeamName = (franchiseId: string) => {
  return leagueAssets.teams?.find?.((f) => f.id === franchiseId)?.name || franchiseId;
};

const getPlayerDisplayName = (player: typeof players[0]): string => {
  if (player.position?.toUpperCase() === 'DEF') {
    const teamName = NFL_TEAM_NAMES[player.nflTeam] || player.nflTeam;
    return `${teamName} Defense`;
  }
  return player.name;
};

const getPlayerAvatarSrc = (player: typeof players[0]): string => {
  if (player.position?.toUpperCase() === 'DEF') {
    return player.nflLogo || DEFAULT_HEADSHOT_URL;
  }
  return player.headshot || DEFAULT_HEADSHOT_URL;
};
---

<div class="veteran-extension-candidates" data-all-players={JSON.stringify(players)} data-season={season}>
  {extensionCandidates.length === 0 ? (
    <div class="no-results">
      <p>No players currently meet the extension criteria (top performer by points or PPG, 2-3 years on contract, under $2.5M salary).</p>
    </div>
  ) : (
    <div class="table-wrapper">
      <table class="eligibility-table">
        <thead>
          <tr>
            <th scope="col">Player</th>
            <th scope="col" class="align-right">Current Years</th>
            <th scope="col" class="align-right">Current Salary</th>
            <th scope="col" class="align-right">New Years</th>
            <th scope="col" class="align-right">New Salary</th>
          </tr>
        </thead>
        <tbody>
          {extensionCandidates.map((player) => {
            const isDefense = player.position?.toUpperCase() === 'DEF';
            const displayName = getPlayerDisplayName(player);
            const avatarSrc = getPlayerAvatarSrc(player);
            const top5Average = seasonAverages.extensionSalaries?.[player.position?.toUpperCase()] ?? 0;
            const extensionCalc = calculateExtensionSalary(player.salary, player.contractYears, top5Average);
            return (
            <tr>
              <td data-label="Player">
                <div class="player-cell">
                  <div class={`player-cell__avatar${isDefense ? ' player-cell__avatar--def' : ''}`}>
                    <img
                      src={avatarSrc}
                      alt={`${displayName} logo`}
                      loading="lazy"
                      decoding="async"
                      onerror={`this.onerror=null;this.src='${DEFAULT_HEADSHOT_URL}';`}
                    />
                  </div>
                  <div>
                    <strong>{displayName}</strong>
                    <div class="player-meta">
                      {!isDefense && player.nflTeam && player.nflTeam !== 'FA' && (
                        <img
                          src={player.nflLogo}
                          alt={`${player.nflTeam} logo`}
                          class="player-meta__logo"
                          loading="lazy"
                          decoding="async"
                        />
                      )}
                      {player.position && <span class="player-meta__pos">{player.position}</span>}
                    </div>
                  </div>
                </div>
              </td>
              <td data-label="Current Years" class="align-center">{player.contractYears}</td>
              <td data-label="Current Salary" class="align-right">{currencyFormatter.format(player.salary)}</td>
              <td data-label="New Years" class="align-center">{player.contractYears + 2}</td>
              <td data-label="New Salary" class="align-right">{currencyFormatter.format(extensionCalc.newContractSalary)}</td>
            </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  )}
</div>

<script>
  // NFL team code to full name mapping
  const NFL_TEAM_NAMES = {
    ARI: 'Arizona', ATL: 'Atlanta', BAL: 'Baltimore', BUF: 'Buffalo',
    CAR: 'Carolina', CHI: 'Chicago', CIN: 'Cincinnati', CLE: 'Cleveland',
    DAL: 'Dallas', DEN: 'Denver', DET: 'Detroit', GB: 'Green Bay',
    HOU: 'Houston', IND: 'Indianapolis', JAC: 'Jacksonville', KC: 'Kansas City',
    LV: 'Las Vegas', LAC: 'Los Angeles', LAR: 'Los Angeles', MIA: 'Miami',
    MIN: 'Minnesota', NE: 'New England', NO: 'New Orleans', NYG: 'New York',
    NYJ: 'New York', PHI: 'Philadelphia', PIT: 'Pittsburgh', SEA: 'Seattle',
    SF: 'San Francisco', TB: 'Tampa Bay', TEN: 'Tennessee', WAS: 'Washington',
  };

  const SALARY_THRESHOLD = 2_500_000; // $2.5 million

  // Position-specific PPG thresholds
  const PPG_THRESHOLDS = {
    QB: 15,
    RB: 30,
    WR: 30,
    TE: 20,
    PK: 20,
    DEF: 15,
  };

  const getPpgThreshold = (position) => {
    const pos = (position ?? 'UNK').toUpperCase();
    return PPG_THRESHOLDS[pos] ?? 20;
  };

  // Helper function to calculate extension salary using the unbreakable formula
  const calculateExtensionSalary = (currentSalary, currentYears, top5Average) => {
    const extensionValuePerYear = (top5Average * 2) / (currentYears + 2);
    const newContractSalary = currentSalary + extensionValuePerYear;
    return newContractSalary;
  };

  // Re-render the veteran extension candidates table when data changes
  const renderVeteranExtensionTable = (containerEl) => {
    const allPlayersJson = containerEl.dataset.allPlayers;
    const currentTeam = containerEl.dataset.currentTeam;
    const salaryAveragesJson = containerEl.dataset.salaryAverages;
    if (!allPlayersJson) return;

    try {
      const allPlayers = JSON.parse(allPlayersJson);

      const calculatePPG = (points, gamesPlayed) => {
        if (!gamesPlayed || gamesPlayed === 0) return 0;
        return points / gamesPlayed;
      };

      const positionOrder = ['QB', 'RB', 'WR', 'TE', 'PK', 'DEF'];

      // Rank ALL league players by position
      const allPlayersByPosition = new Map();
      allPlayers.forEach((player) => {
        const pos = (player.position ?? 'UNK').toUpperCase();
        if (!allPlayersByPosition.has(pos)) {
          allPlayersByPosition.set(pos, []);
        }
        allPlayersByPosition.get(pos).push(player);
      });

      // Sort each position by points and get rankings
      const pointsRankings = new Map();
      allPlayersByPosition.forEach((posPlayers, pos) => {
        posPlayers
          .sort((a, b) => (b.points ?? 0) - (a.points ?? 0))
          .forEach((player, idx) => {
            pointsRankings.set(player.id, idx + 1);
          });
      });

      // Calculate PPG rankings
      const ppgRankings = new Map();
      allPlayersByPosition.forEach((posPlayers, pos) => {
        const playersWithPPG = posPlayers
          .map(p => ({ ...p, ppg: calculatePPG(p.points ?? 0, p.gamesPlayed) }))
          .sort((a, b) => b.ppg - a.ppg);

        playersWithPPG.forEach((player, idx) => {
          ppgRankings.set(player.id, idx + 1);
        });
      });

      // Filter to only the current team's players for display
      const teamPlayers = currentTeam ? allPlayers.filter(p => p.franchiseId === currentTeam) : allPlayers;

      // Filter eligible players
      const eligible = [];
      teamPlayers.forEach((player) => {
        // Must have 2-3 years on contract
        if (player.contractYears !== 2 && player.contractYears !== 3) return;

        // Must be under salary threshold
        if ((player.salary ?? 0) >= SALARY_THRESHOLD) return;

        // Must have positive points
        if ((player.points ?? 0) <= 0) return;

        const ppg = calculatePPG(player.points ?? 0, player.gamesPlayed);
        const pointsRank = pointsRankings.get(player.id) || Infinity;
        const ppgRank = ppgRankings.get(player.id) || Infinity;
        const posThreshold = getPpgThreshold(player.position);

        // Must be top 20 by points OR position-specific threshold by PPG
        if (pointsRank <= 20 || ppgRank <= posThreshold) {
          eligible.push({
            ...player,
            ppg,
            pointsRank,
            ppgRank,
            position: (player.position ?? 'UNK').toUpperCase()
          });
        }
      });

      // Sort by position order for display
      const withRanks = eligible.sort((a, b) => {
        const posA = a.position?.toUpperCase() || 'UNK';
        const posB = b.position?.toUpperCase() || 'UNK';
        const posDiff = positionOrder.indexOf(posA) - positionOrder.indexOf(posB);
        if (posDiff !== 0) return posDiff;
        return (a.pointsRank ?? 0) - (b.pointsRank ?? 0);
      });

      if (withRanks.length === 0) {
        containerEl.innerHTML = '<div class="no-results"><p>No players currently meet the extension criteria (top performer by points or PPG, 2-3 years on contract, under $2.5M salary).</p></div>';
        return;
      }

      // Build table HTML
      let tableHtml = `
        <div class="table-wrapper">
          <table class="eligibility-table">
            <thead>
              <tr>
                <th scope="col">Player</th>
                <th scope="col" class="align-right">Current Years</th>
                <th scope="col" class="align-right">Current Salary</th>
                <th scope="col" class="align-right">New Years</th>
                <th scope="col" class="align-right">New Salary</th>
              </tr>
            </thead>
            <tbody>
      `;

      const currencyFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0,
      });

      const DEFAULT_HEADSHOT = 'https://s.yimg.com/cv/apiv2/default/nfl/nophoto.png';

      // Parse salary averages for extension calculations
      let salaryAverages = {};
      if (salaryAveragesJson) {
        try {
          salaryAverages = JSON.parse(salaryAveragesJson);
        } catch (e) {
          console.warn('Failed to parse salary averages');
        }
      }

      withRanks.forEach((player) => {
        const isDefense = (player.position ?? '').toUpperCase() === 'DEF';
        const displayName = isDefense
          ? `${NFL_TEAM_NAMES[player.nflTeam] || player.nflTeam} Defense`
          : player.name;
        const avatarSrc = isDefense ? player.nflLogo : (player.headshot || DEFAULT_HEADSHOT);
        const nflTeam = player.nflTeam || 'FA';

        // Calculate extension salary using the unbreakable formula
        const top5Average = salaryAverages[player.position?.toUpperCase()] ?? 0;
        const extensionSalary = calculateExtensionSalary(player.salary, player.contractYears, top5Average);

        tableHtml += `
          <tr>
            <td data-label="Player">
              <div class="player-cell">
                <div class="player-cell__avatar${isDefense ? ' player-cell__avatar--def' : ''}">
                  <img src="${avatarSrc}" alt="${displayName} logo" loading="lazy"
                       onerror="this.onerror=null;this.src='${DEFAULT_HEADSHOT}';" />
                </div>
                <div>
                  <strong>${displayName}</strong>
                  <div class="player-meta">
                    ${!isDefense && player.nflLogo ? `<img src="${player.nflLogo}" alt="${nflTeam} logo" class="player-meta__logo" loading="lazy" />` : ''}
                    ${player.position ? `<span class="player-meta__pos">${player.position}</span>` : ''}
                  </div>
                </div>
              </div>
            </td>
            <td data-label="Current Years" class="align-center">${player.contractYears}</td>
            <td data-label="Current Salary" class="align-right">${currencyFormatter.format(player.salary)}</td>
            <td data-label="New Years" class="align-center">${player.contractYears + 2}</td>
            <td data-label="New Salary" class="align-right">${currencyFormatter.format(extensionSalary)}</td>
          </tr>
        `;
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      containerEl.innerHTML = tableHtml;
    } catch (error) {
      console.error('Failed to render veteran extension candidates:', error);
    }
  };

  // Find and render all veteran extension candidates containers
  document.querySelectorAll('.veteran-extension-candidates').forEach((el) => {
    renderVeteranExtensionTable(el);
  });

  // Watch for data updates
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && (mutation.attributeName === 'data-all-players' || mutation.attributeName === 'data-current-team' || mutation.attributeName === 'data-salary-averages')) {
        renderVeteranExtensionTable(mutation.target);
      }
    });
  });

  document.querySelectorAll('.veteran-extension-candidates').forEach((el) => {
    observer.observe(el, { attributes: true });
  });
</script>

<style is:global>
  .veteran-extension-candidates {
    width: 100%;
  }

  .veteran-extension-candidates .no-results {
    text-align: center;
    padding: 2rem;
    background: #f5f5f5;
    border-radius: 8px;
    color: #666;
    font-size: 0.95rem;
  }

  .veteran-extension-candidates .table-wrapper {
    overflow-x: auto;
  }

  .veteran-extension-candidates .eligibility-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .veteran-extension-candidates .eligibility-table thead {
    background: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
  }

  .veteran-extension-candidates .eligibility-table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #333;
  }

  .veteran-extension-candidates .eligibility-table th.align-right {
    text-align: right;
  }

  .veteran-extension-candidates .eligibility-table th.align-center {
    text-align: center;
  }

  .veteran-extension-candidates .eligibility-table tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background 0.2s ease;
  }

  .veteran-extension-candidates .eligibility-table tbody tr:nth-child(even) {
    background: #f7f8fb;
  }

  .veteran-extension-candidates .eligibility-table tbody tr:hover {
    background: #eef1fb;
  }

  .veteran-extension-candidates .eligibility-table td {
    padding: 0.75rem;
    vertical-align: middle;
  }

  .veteran-extension-candidates .eligibility-table td.align-right {
    text-align: right;
    padding-right: 0.5rem;
  }

  .veteran-extension-candidates .eligibility-table td.align-center {
    text-align: center;
  }

  .veteran-extension-candidates .eligibility-table td[data-label="Current Salary"],
  .veteran-extension-candidates .eligibility-table td[data-label="Contract Years"],
  .veteran-extension-candidates .eligibility-table td[data-label="PPG"] {
    font-size: 0.85rem;
    color: #555;
  }

  .veteran-extension-candidates .player-cell {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .veteran-extension-candidates .player-cell__avatar {
    flex-shrink: 0;
  }

  .veteran-extension-candidates .player-cell__avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .veteran-extension-candidates .player-cell__avatar--def img {
    border-radius: 4px;
    object-fit: contain;
    background: #f0f0f0;
  }

  .veteran-extension-candidates .player-cell strong {
    display: block;
    margin-bottom: 0.15rem;
    color: #1a1a1a;
    font-size: 0.95rem;
  }

  .veteran-extension-candidates .player-meta {
    display: flex;
    gap: 0.4rem;
    align-items: center;
    font-size: 0.8rem;
    color: #666;
  }

  .veteran-extension-candidates .player-meta__logo {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  .veteran-extension-candidates .player-meta__pos {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #475569;
  }

  @media (max-width: 767px) {
    .veteran-extension-candidates .eligibility-table {
      font-size: 0.8rem;
    }

    .veteran-extension-candidates .eligibility-table th,
    .veteran-extension-candidates .eligibility-table td {
      padding: 0.5rem;
    }

    .veteran-extension-candidates .player-cell__avatar img {
      width: 32px;
      height: 32px;
    }
  }
</style>
