---
import type { TeamStanding } from '../../types/standings';

export interface Props {
  conferenceName: string;
  teams: TeamStanding[];
  year?: number;
  preferredTeamId?: string;
}

const { conferenceName, teams, year = new Date().getFullYear(), preferredTeamId } = Astro.props;

function parseWLT(wlt: string | undefined) {
  if (!wlt) return { w: 0, l: 0, t: 0 };
  const parts = wlt.split('-').map(Number);
  return { w: parts[0] || 0, l: parts[1] || 0, t: parts[2] || 0 };
}

// Derive all_play_wlt from percentage when the record is missing
function deriveAllPlayWLT(pct: string | undefined, seasonYear: number): { w: number; l: number; t: number } | null {
  if (!pct) return null;
  const TOTAL_GAMES = seasonYear >= 2021 ? 255 : 240;
  const percentage = parseFloat(pct);
  if (isNaN(percentage)) return null;
  const wins = Math.round(TOTAL_GAMES * percentage);
  const losses = TOTAL_GAMES - wins;
  return { w: wins, l: losses, t: 0 };
}

function safeParseFloat(value: string | undefined, decimals: number): string {
  if (!value) return (0).toFixed(decimals);
  return parseFloat(value).toFixed(decimals);
}

function safeParseInt(value: string | undefined): string {
  if (!value) return '0';
  return parseInt(value).toString();
}

function getRowColor(seed: number | undefined): string {
  if (!seed) return '';
  if (seed <= 2) return 'tier-division-winners';
  if (seed <= 4) return 'tier-wild-cards';
  return 'tier-eliminated';
}
---
<div class="conference-standings-container">
  <h2 class="conference-title">{conferenceName}</h2>

  <div class="table-wrapper">
    <table class="conference-standings-table">
      <thead>
        <tr>
          <th class="col-seed">Seed</th>
          <th class="col-team">Team</th>
          <th class="col-overall-record">Overall</th>
          <th class="col-overall-pct">PCT</th>
          <th class="col-div-record">Div</th>
          <th class="col-div-pct">PCT</th>
          <th class="col-allplay">All Play</th>
          <th class="col-pf">PF</th>
          <th class="col-pwr">PWR</th>
          <th class="col-vp">VP</th>
          <th class="col-pa">PA</th>
        </tr>
      </thead>
      <tbody>
        {teams.map((team, index) => {
          const overallRecord = parseWLT(team.h2hwlt);
          const divRecord = parseWLT(team.divwlt);
          const allPlayRecord = team.all_play_wlt
            ? parseWLT(team.all_play_wlt)
            : deriveAllPlayWLT(team.all_play_pct, year);
          const rowColor = getRowColor(team.conferenceSeed);
          const nextTeam = teams[index + 1];
          const nextTier = nextTeam ? getRowColor(nextTeam.conferenceSeed) : '';
          const isTierBoundary = rowColor !== nextTier && nextTeam;

          // Add preferred team class
          const isPreferredTeam = preferredTeamId && team.id === preferredTeamId;
          const preferredClass = isPreferredTeam ? 'preferred-team' : '';

          return (
            <tr class={`conference-row ${rowColor} ${isTierBoundary ? 'tier-boundary' : ''} ${preferredClass}`}>
              <td class="col-seed">
                <span class="seed-number">#{team.conferenceSeed}</span>
              </td>
              <td class="col-team">
                <div class="team-info">
                  {team.teamBanner && (
                    <img
                      src={team.teamBanner}
                      alt={team.teamName}
                      class="team-banner"
                      title={team.teamName}
                    />
                  )}
                </div>
              </td>
              <td class="col-overall-record">
                {overallRecord.w}-{overallRecord.l}-{overallRecord.t}
              </td>
              <td class="col-overall-pct">
                {safeParseFloat(team.h2hpct, 3)}
              </td>
              <td class="col-div-record">
                {divRecord.w}-{divRecord.l}-{divRecord.t}
              </td>
              <td class="col-div-pct">
                {safeParseFloat(team.divpct, 3)}
              </td>
              <td class="col-allplay">
                {allPlayRecord ? `${allPlayRecord.w}-${allPlayRecord.l}-${allPlayRecord.t}` : 'N/A'}
              </td>
              <td class="col-pf">
                {safeParseFloat(team.pf, 1)}
              </td>
              <td class="col-pwr">
                {safeParseFloat(team.pwr, 1)}
              </td>
              <td class="col-vp">
                {safeParseInt(team.vp)}
              </td>
              <td class="col-pa">
                {safeParseFloat(team.pa, 1)}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</div>

<style>
  .conference-standings-container {
    margin-bottom: 2rem;
    background-color: #fff;
    border-radius: 1rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    overflow: hidden;
  }

  .conference-title {
    font-size: 1.75rem;
    font-weight: 700;
    padding: 1.5rem 2rem;
    margin: 0;
    background: linear-gradient(135deg, #c41e3a 0%, #002244 100%);
    color: white;
  }

  .table-wrapper {
    overflow-x: auto;
    padding: 1.5rem 2rem;
  }

  .conference-standings-table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background-color: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
  }

  th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  td {
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.875rem;
    color: #1e293b;
  }

  tbody tr {
    transition: background-color 0.2s ease;
  }

  tbody tr:hover {
    background-color: #f8fafc;
  }

  /* Tier Color Schemes */
  .tier-division-winners {
    background-color: #fef8e7;
  }

  .tier-wild-cards {
    background-color: #f3f3f3;
  }

  .tier-eliminated {
    background-color: #fff;
  }

  /* Tier Boundary Dividers */
  .tier-division-winners.tier-boundary {
    border-bottom: 3px solid #d4a856 !important;
  }

  .tier-wild-cards.tier-boundary {
    border-bottom: 3px solid #cbd5e1 !important;
  }

  /* Column Widths */
  .col-seed {
    width: 80px;
    text-align: center;
    font-weight: 700;
    color: #c41e3a;
    font-size: 1.125rem;
  }

  .col-team {
    width: auto;
    min-width: 250px;
  }

  .col-overall-record {
    width: 110px;
    text-align: center;
    white-space: nowrap;
    font-weight: 600;
  }

  .col-overall-pct {
    width: 90px;
    text-align: center;
  }

  .col-div-record {
    width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .col-div-pct {
    width: 90px;
    text-align: center;
  }

  .col-allplay {
    width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .col-pf,
  .col-pa {
    width: 110px;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  .col-pwr {
    width: 100px;
    text-align: center;
  }

  .col-vp {
    width: 90px;
    text-align: center;
  }

  /* Team Info */
  .team-info {
    display: flex;
    align-items: center;
  }

  .team-banner {
    width: 100%;
    max-width: 400px;
    height: auto;
    object-fit: contain;
  }

  .seed-number {
    font-weight: 700;
    font-size: 1rem;
    display: inline-block;
  }

  /* Preferred Team Highlighting */
  tbody tr.preferred-team {
    background-color: #2e743d12 !important;
    border-left: 3px solid #2e743d;
  }

  tbody tr.preferred-team:hover {
    background-color: #2e743d36 !important;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .conference-title {
      font-size: 1.5rem;
      padding: 1rem 1.5rem;
    }

    .table-wrapper {
      padding: 1rem 1.5rem;
    }

    .col-team {
      min-width: 100px;
    }

    th,
    td {
      padding: 0.5rem;
      font-size: 0.75rem;
    }

    .team-banner {
      max-width: 200px;
    }

    .seed-number {
      font-size: 0.9rem;
    }

    /* Hide some columns on mobile */
    .col-div-pct,
    .col-pwr,
    .col-pa {
      display: none;
    }
  }
</style>
