---
/**
 * DraftPredictorGrid - Grid display of all draft picks organized by round
 * Shows picks grouped by round with Compensatory picks marked as TBD
 * Configurable for different league formats (theLeague vs AFL Fantasy)
 */

import type { DraftPrediction } from '../../types/standings';

export interface Props {
  predictions: DraftPrediction[];
  totalRounds?: number; // Default 3 for theLeague, 9 for AFL Fantasy
  teamsPerConference?: number; // Default 16 for theLeague, 12 for AFL Fantasy
  hasCompensatoryPicks?: boolean; // Default true for theLeague, false for AFL Fantasy
}

const {
  predictions,
  totalRounds = 3,
  teamsPerConference = 16,
  hasCompensatoryPicks = true
} = Astro.props;

// Sort predictions by overall pick number
const sortedPredictions = [...predictions].sort(
  (a, b) => a.overallPickNumber - b.overallPickNumber
);

const formatTeamName = (name: string) => {
  const normalized = (name || '').trim();
  const key = normalized.toLowerCase();
  const replacements: Record<string, string> = {
    'the mariachi ninjas': 'Mariachi Ninjas',
    'running down the dream': 'The Dream',
    'dark magicians of chaos': 'Dark Magicians',
  };
  if (replacements[key]) return replacements[key];
  return normalized;
};

const championUnknown = !sortedPredictions.some((p) => p.isLeagueWinner);
const isChampionPick = (pick: DraftPrediction) => pick.pickInRound === teamsPerConference;

// Group picks by round dynamically
const picksByRound: Record<number, DraftPrediction[]> = {};
for (let round = 1; round <= totalRounds; round++) {
  picksByRound[round] = sortedPredictions.filter((p) => p.round === round);
}

// Check which Compensatory picks have assignments (only for theLeague)
const specialPicksAssigned = hasCompensatoryPicks ? {
  '1.17': sortedPredictions.some((p) => p.round === 1 && p.pickInRound === 17),
  '2.17': sortedPredictions.some((p) => p.round === 2 && p.pickInRound === 17),
  '2.18': sortedPredictions.some((p) => p.round === 2 && p.pickInRound === 18),
} : {};
---

<div class="draft-rounds-container">
  {Object.entries(picksByRound).map(([roundNum, roundPicks]) => {
    const round = parseInt(roundNum);
    const startPick = (round - 1) * teamsPerConference + 1;
    const endPick = round * teamsPerConference;
    const roundTitle = hasCompensatoryPicks && round === 1
      ? `Round ${round} (Picks ${startPick}-${endPick} + Compensatory ${round}.17)`
      : hasCompensatoryPicks && round === 2
      ? `Round ${round} (Picks ${startPick}-${endPick} + Compensatory ${round}.17, ${round}.18)`
      : `Round ${round} (Picks ${startPick}-${endPick})`;

    return (
      <div class="draft-round">
        <h3 class="draft-round__title">{roundTitle}</h3>
        <div class="draft-round__picks">
          {roundPicks.map((pick) => (
            <div
              class:list={[
                'draft-pick',
                {
                  'draft-pick--league-winner': pick.isLeagueWinner,
                  'draft-pick--toilet-bowl': pick.isToiletBowlPick,
                  'draft-pick--champion': isChampionPick(pick),
                  'draft-pick--champion-tbd': championUnknown && isChampionPick(pick),
                },
              ]}
              title={`${pick.teamName} - Pick ${pick.round}.${pick.pickInRound}`}
            >
              <div class="draft-pick__content">
                <div class="draft-pick__icon-container">
                  {pick.teamIcon && (
                    <img
                      src={pick.teamIcon}
                      alt={pick.teamName}
                      class="draft-pick__icon"
                    />
                  )}
                  {pick.isTraded && pick.originalTeamIcon && (
                    <img
                      src={pick.originalTeamIcon}
                      alt={pick.originalTeamName}
                      class="draft-pick__icon draft-pick__icon--original"
                      title={`Originally owned by ${pick.originalTeamName}`}
                    />
                  )}
                </div>
                <div class="draft-pick__name">{formatTeamName(pick.teamName)}</div>
                <div class="draft-pick__number">
                  {pick.round}.{String(pick.pickInRound).padStart(2, '0')}
                </div>
                {isChampionPick(pick) && (
                  <div class="draft-pick__label">{championUnknown ? 'Reserved for Champ' : 'League Champion'}</div>
                )}
              </div>
            </div>
          ))}

          {/* Compensatory picks for theLeague only */}
          {hasCompensatoryPicks && round === 1 && !specialPicksAssigned['1.17'] && (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">1.17</div>
                <div class="draft-pick__label">Toilet Bowl</div>
              </div>
            </div>
          )}
          {hasCompensatoryPicks && round === 2 && !specialPicksAssigned['2.17'] && (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">2.17</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          )}
          {hasCompensatoryPicks && round === 2 && !specialPicksAssigned['2.18'] && (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">2.18</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  })}

  <!-- Legend -->
  <div class="draft-round">
    <h3 class="draft-round__title">Legend</h3>
    <div class="draft-round__picks">
      {/* Champion placeholders - one for each round */}
      {Array.from({ length: totalRounds }, (_, i) => i + 1).map((round) => (
        <div class="draft-pick draft-pick--champion draft-pick--champion-tbd">
          <div class="draft-pick__content">
            <div class="draft-pick__icon-container">
              <svg viewBox="0 0 64 64" class="draft-pick__icon draft-pick__icon--crown" aria-hidden="true">
                <path d="M8 22l10 8 8-14 8 14 10-8 4 20H4l4-20z" fill="currentColor"/>
                <rect x="4" y="42" width="56" height="8" rx="2" fill="currentColor" opacity="0.15"/>
              </svg>
            </div>
            <div class="draft-pick__name">League Champion</div>
            <div class="draft-pick__number">{round}.{String(teamsPerConference).padStart(2, '0')}</div>
            <div class="draft-pick__label">Reserved</div>
          </div>
        </div>
      ))}

      {/* Compensatory picks for theLeague only */}
      {hasCompensatoryPicks && (
        <>
          {/* Pick 1.17 */}
          {sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17) ? (
            <div class="draft-pick draft-pick--toilet-bowl">
              <div class="draft-pick__content">
                <div class="draft-pick__icon-container">
                  {sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.teamIcon && (
                    <img
                      src={sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.teamIcon}
                      alt={sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.teamName}
                      class="draft-pick__icon"
                    />
                  )}
                  {sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.isTraded &&
                    sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.originalTeamIcon && (
                    <img
                      src={sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.originalTeamIcon}
                      alt={sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.originalTeamName}
                      class="draft-pick__icon draft-pick__icon--original"
                      title={`Originally owned by ${sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.originalTeamName}`}
                    />
                  )}
                </div>
                <div class="draft-pick__name">
                  {formatTeamName(sortedPredictions.find((p) => p.round === 1 && p.pickInRound === 17)?.teamName || '')}
                </div>
                <div class="draft-pick__number">1.17</div>
                <div class="draft-pick__label">Toilet Bowl</div>
              </div>
            </div>
          ) : (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">1.17</div>
                <div class="draft-pick__label">Toilet Bowl</div>
              </div>
            </div>
          )}

          {/* Pick 2.17 */}
          {sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 17) ? (
            <div class="draft-pick draft-pick--toilet-bowl">
              <div class="draft-pick__content">
                {sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 17)?.teamIcon && (
                  <img
                    src={sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 17)?.teamIcon}
                    alt={sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 17)?.teamName}
                    class="draft-pick__icon"
                  />
                )}
                <div class="draft-pick__name">
                  {formatTeamName(sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 17)?.teamName || '')}
                </div>
                <div class="draft-pick__number">2.17</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          ) : (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">2.17</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          )}

          {/* Pick 2.18 */}
          {sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 18) ? (
            <div class="draft-pick draft-pick--toilet-bowl">
              <div class="draft-pick__content">
                {sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 18)?.teamIcon && (
                  <img
                    src={sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 18)?.teamIcon}
                    alt={sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 18)?.teamName}
                    class="draft-pick__icon"
                  />
                )}
                <div class="draft-pick__name">
                  {formatTeamName(sortedPredictions.find((p) => p.round === 2 && p.pickInRound === 18)?.teamName || '')}
                </div>
                <div class="draft-pick__number">2.18</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          ) : (
            <div class="draft-pick draft-pick--tbd draft-pick--special">
              <div class="draft-pick__content">
                <div class="draft-pick__name">TBD</div>
                <div class="draft-pick__number">2.18</div>
                <div class="draft-pick__label">Consolation</div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  </div>



<style>
  .draft-rounds-container {
    display: grid;
    gap: 2rem;
  }

  .draft-round {
    display: grid;
    gap: 1rem;
    background: var(--card-bg-color, #fff);
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: var(--box-shadow-lg, 0 10px 15px -3px rgb(0 0 0 / 0.1));
  }

  .draft-round__title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary-color, #111827);
  }

  .draft-round__picks {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }

  .draft-pick {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80px;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: 2px solid transparent;
    background: #f3f4f6;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    text-decoration: none;
  }

  .draft-pick:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
  }

  .draft-pick--league-winner {
    background: #fffbeb;
    border-color: #fbbf24;
  }

  .draft-pick--champion {
    background: #fff7ed;
    border-color: #fb923c;
    color: #c2410c;
  }

  .draft-pick--champion-tbd {
    border-style: dashed;
  }

  .draft-pick--league-winner:hover {
    background: #fef3c7;
    border-color: #f59e0b;
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #f59e0b, 0 4px 12px rgb(0 0 0 / 0.15);
  }

  .draft-pick--toilet-bowl {
    background: #fef2f2;
    border-color: #ff6b6b;
    border-style: dashed;
  }

  .draft-pick--toilet-bowl:hover {
    background: #fee2e2;
    border-color: #ff5252;
    box-shadow: 0 0 0 1px #ff6b6b, 0 4px 12px rgb(0 0 0 / 0.15);
  }

  .draft-pick--tbd {
    background: #f5f3ff;
    border-color: #c4b5fd;
    border-style: dashed;
  }

  .draft-pick--tbd:hover {
    background: #ede9fe;
    border-color: #a78bfa;
  }

  .draft-pick--special {
    box-shadow: 0 0 0 1px rgba(167, 139, 250, 0.2);
  }

  .draft-pick__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    text-align: center;
  }

  .draft-pick__icon-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
  }

  .draft-pick__icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    flex-shrink: 0;
    color: #fb923c;
  }

  .draft-pick__icon--original {
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 20px;
    height: 20px;
    border: 1px solid #fff;
    border-radius: 50%;
    object-fit: contain;
    background-color: var(--card-bg-color, #fff);
  }

  .draft-pick__name {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-primary-color, #111827);
    line-height: 1.2;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    min-height: 2rem;
    align-content: center;
  }

  .draft-pick__number {
    font-size: 0.875rem;
    font-weight: 700;
    color: #2563eb;
  }

  .draft-pick__label {
    font-size: 0.625rem;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .draft-grid-legend {
    display: flex;
    gap: 2rem;
    justify-content: center;
    padding: 1.5rem;
    font-size: 0.875rem;
    color: #64748b;
    background: var(--card-bg-color, #fff);
    border-radius: 1rem;
    box-shadow: var(--box-shadow-lg, 0 10px 15px -3px rgb(0 0 0 / 0.1));
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .legend-swatch {
    width: 1rem;
    height: 1rem;
    border-radius: 0.25rem;
    flex-shrink: 0;
  }

  .legend-swatch--league-winner {
    background: #fbbf24;
    border: 2px solid #f59e0b;
  }

  .legend-swatch--toilet-bowl {
    background: #fee2e2;
    border: 2px dashed #ff6b6b;
  }

  .legend-swatch--tbd {
    background: #f5f3ff;
    border: 2px dashed #c4b5fd;
  }

  @media (max-width: 1024px) {
    .draft-round__picks {
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    }

    .draft-pick {
      min-height: 75px;
      padding: 0.5rem;
    }

    .draft-pick__icon-container {
      width: 35px;
      height: 35px;
    }

    .draft-pick__icon {
      width: 35px;
      height: 35px;
    }

    .draft-pick__icon--original {
      width: 18px;
      height: 18px;
    }

    .draft-pick__name {
      font-size: 0.7rem;
    }

    .draft-pick__number {
      font-size: 0.8rem;
    }
  }

  @media (max-width: 640px) {
    .draft-round {
      padding: 1rem;
      gap: 0.75rem;
    }

    .draft-round__title {
      font-size: 1.1rem;
    }

    .draft-round__picks {
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 0.5rem;
    }

    .draft-pick {
      min-height: 70px;
      padding: 0.4rem;
    }

    .draft-pick__icon-container {
      width: 30px;
      height: 30px;
    }

    .draft-pick__icon {
      width: 30px;
      height: 30px;
    }

    .draft-pick__icon--original {
      width: 15px;
      height: 15px;
      bottom: -2px;
      right: -2px;
    }

    .draft-pick__name {
      font-size: 0.625rem;
      -webkit-line-clamp: 1;
    }

    .draft-pick__number {
      font-size: 0.7rem;
    }

    .draft-pick__label {
      font-size: 0.5rem;
    }

    .draft-grid-legend {
      gap: 1rem;
      font-size: 0.75rem;
      flex-wrap: wrap;
      padding: 1rem;
    }
  }
</style>
