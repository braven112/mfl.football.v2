---
import type { TeamStanding } from '../../types/standings';

export interface Props {
  tierName: string;
  teams: TeamStanding[];
  year?: number;
}

const { tierName, teams, year = new Date().getFullYear() } = Astro.props;

// Determine logo based on tier
const tierLogo = tierName === 'Premier League'
  ? '/assets/afl/premier.svg'
  : '/assets/afl/dleague.svg';

function parseWLT(wlt: string | undefined) {
  if (!wlt) return { w: 0, l: 0, t: 0 };
  const parts = wlt.split('-').map(Number);
  return { w: parts[0] || 0, l: parts[1] || 0, t: parts[2] || 0 };
}

// Derive all_play_wlt from percentage when the record is missing
function deriveAllPlayWLT(pct: string | undefined, seasonYear: number): { w: number; l: number; t: number } | null {
  if (!pct) return null;
  const TOTAL_GAMES = seasonYear >= 2021 ? 255 : 240;
  const percentage = parseFloat(pct);
  if (isNaN(percentage)) return null;
  const wins = Math.round(TOTAL_GAMES * percentage);
  const losses = TOTAL_GAMES - wins;
  return { w: wins, l: losses, t: 0 };
}

// Prize values based on All-Play standings
const prizes: Record<string, string[]> = {
  'Premier League': ['$225', '$150', '$100', '$50', '', '', '', '', '', '', '', ''],
  'D-League': ['$50', '', '', '', '', '', '', '', '', '', '', '']
};
---

<div class="tier-standings-container">
  <div class="tier-header-section">
    <img src={tierLogo} alt={`${tierName} Logo`} class="tier-logo" />
    <h3 class="tier-header">{tierName}</h3>
  </div>

  <div class="table-wrapper">
    <table class="tier-standings-table">
      <thead>
        <tr>
          <th class="col-rank">Rank</th>
          <th class="col-team">Team</th>
          <th class="col-record">All-Play Record</th>
          <th class="col-prize">Prize</th>
        </tr>
      </thead>
      <tbody>
        {teams.map((team, index) => {
          const record = team.all_play_wlt
            ? parseWLT(team.all_play_wlt)
            : deriveAllPlayWLT(team.all_play_pct, year);

          const prizeValue = prizes[tierName]?.[index] || '';
          const rank = index + 1;

          // Determine row class based on tier and rank
          let rowClass = '';
          if (tierName === 'Premier League') {
            if (rank === 1) rowClass = 'gold-tier';
            else if (rank === 2) rowClass = 'silver-tier';
            else if (rank === 3) rowClass = 'bronze-tier';
            else if (rank === 4) rowClass = 'playoff-tier';
            else if (rank === 9 || rank === 10) rowClass = 'relegation-danger';
            else if (rank === 11 || rank === 12) rowClass = 'relegated';
          } else if (tierName === 'D-League') {
            if (rank === 1) rowClass = 'gold-tier';
            else if (rank === 2) rowClass = 'second-place';
            else if (rank === 3 || rank === 4) rowClass = 'dleague-playoff-tier';
            else if (rank === 12) rowClass = 'last-place';
          }

          // Add border classes
          let borderClass = '';
          if (tierName === 'Premier League') {
            if (rank === 8) borderClass = 'border-below';
            if (rank === 10) borderClass = 'border-below-relegation';
          } else if (tierName === 'D-League') {
            if (rank === 2) borderClass = 'border-below-green';
            if (rank === 4) borderClass = 'border-below-playoff';
          }

          return (
            <tr class={`${rowClass} ${borderClass}`}>
              <td class="col-rank">
                <span class="rank-number">{rank}</span>
              </td>
              <td class="col-team">
                <div class="team-info">
                  {team.teamIcon && (
                    <img
                      src={team.teamIcon}
                      alt={team.teamName}
                      class="team-icon"
                      loading="lazy"
                    />
                  )}
                  <span class="team-name">{team.teamName}</span>
                </div>
              </td>
              <td class="col-record">
                {record ? `${record.w}-${record.l}${record.t > 0 ? `-${record.t}` : ''}` : 'N/A'}
              </td>
              <td class="col-prize">
                {prizeValue && <span class="prize-amount">{prizeValue}</span>}
                {tierName === 'D-League' && rank === 2 && <span class="promo-arrow rank-2">⬆</span>}
                {tierName === 'D-League' && rank === 3 && <span class="promo-arrow rank-3">⬆</span>}
                {tierName === 'D-League' && rank === 4 && <span class="promo-arrow rank-4">⬆</span>}
                {tierName === 'Premier League' && rank === 9 && <span class="promo-arrow pl-rank-9">⬇</span>}
                {tierName === 'Premier League' && rank === 10 && <span class="promo-arrow pl-rank-10">⬇</span>}
                {tierName === 'Premier League' && rank === 11 && <span class="promo-arrow pl-rank-11">⬇</span>}
                {tierName === 'Premier League' && rank === 12 && <span class="promo-arrow pl-rank-12">⬇</span>}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</div>

<style>
  .tier-standings-container {
    background: #fff;
    border-radius: 1rem;
    box-shadow: var(--box-shadow-lg, 0 10px 15px -3px rgb(0 0 0 / 0.1));
    overflow: hidden;
  }

  .tier-header-section {
    padding: 1.5rem 2rem;
    background: #fff;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .tier-logo {
    height: 50px;
    width: auto;
    object-fit: contain;
  }

  .tier-header {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #002244;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .tier-standings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  thead {
    background: var(--color-bg-secondary, #f8f9fa);
    border-bottom: 2px solid var(--color-border, #dee2e6);
  }

  th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 700;
    color: var(--text-primary-color, #111827);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .col-rank {
    width: 60px;
    text-align: center;
  }

  .col-team {
    min-width: 200px;
  }

  .col-record {
    width: 120px;
    text-align: center;
  }

  .col-prize {
    width: 100px;
    text-align: center;
  }

  tbody tr {
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    transition: background-color 0.15s ease;
  }

  tbody tr:hover {
    background-color: var(--color-bg-hover, #f9fafb);
  }

  tbody tr:last-child {
    border-bottom: none;
  }

  td {
    padding: 1rem;
  }

  .col-rank td {
    text-align: center;
  }

  .rank-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #9ca3af;
    color: #fff;
    font-weight: 700;
    font-size: 0.875rem;
  }

  /* Premier League rank badge colors */
  tbody tr.gold-tier .rank-number {
    background: #ffd700;
    color: #000;
  }

  tbody tr.silver-tier .rank-number {
    background: #c0c0c0;
    color: #000;
  }

  tbody tr.bronze-tier .rank-number {
    background: #cd7f32;
    color: #fff;
  }

  tbody tr.playoff-tier .rank-number {
    background: #22c55e;
    color: #fff;
  }

  tbody tr.relegation-danger .rank-number {
    background: #ef4444;
    color: #fff;
  }

  tbody tr.relegated .rank-number {
    background: #dc2626;
    color: #fff;
  }

  /* D-League rank badge colors */
  tbody tr.second-place .rank-number {
    background: #16a34a;
    color: #fff;
  }

  .team-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .team-icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    flex-shrink: 0;
  }

  .team-name {
    font-weight: 600;
    color: var(--text-primary-color, #111827);
  }

  .col-record td {
    text-align: center;
    font-weight: 600;
    font-family: var(--font-mono, monospace);
  }

  .col-prize td {
    text-align: center;
  }

  .prize-amount {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #000;
    font-weight: 700;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  /* Premier League tier styling */
  tbody tr.gold-tier {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 223, 0, 0.1) 100%);
    border-bottom: 4px solid #ffd700;
  }

  tbody tr.silver-tier {
    background: linear-gradient(135deg, rgba(192, 192, 192, 0.15) 0%, rgba(192, 192, 192, 0.1) 100%);
    border-bottom: 4px solid #c0c0c0;
  }

  tbody tr.bronze-tier {
    background: linear-gradient(135deg, rgba(205, 127, 50, 0.15) 0%, rgba(205, 127, 50, 0.1) 100%);
    border-bottom: 4px solid #cd7f32;
  }

  tbody tr.playoff-tier {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.12) 0%, rgba(34, 197, 94, 0.08) 100%);
    border-bottom: 4px solid #22c55e;
  }

  tbody tr.relegation-danger {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.05) 100%);
  }

  tbody tr.relegated {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.1) 100%);
  }

  tbody tr.border-below {
    border-bottom: 3px solid #ef4444;
  }

  tbody tr.border-below-relegation {
    border-bottom: 3px solid #dc2626;
  }

  /* D-League tier styling */
  tbody tr.second-place {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.18) 100%);
    color: #000;
  }

  tbody tr.second-place .team-name,
  tbody tr.second-place .col-record,
  tbody tr.second-place .col-prize {
    color: #000;
  }

  tbody tr.last-place {
    background: linear-gradient(135deg, #7c4a2e 0%, #6b4423 100%);
    color: #fff;
  }

  tbody tr.last-place .team-name,
  tbody tr.last-place .col-record,
  tbody tr.last-place .col-prize,
  tbody tr.last-place .prize-amount {
    color: #fff;
  }

  tbody tr.last-place .rank-number {
    background: #5a3620;
    color: #fff;
  }

  tbody tr.border-below-green {
    border-bottom: 4px solid #22c55e;
  }

  tbody tr.border-below-playoff {
    border-bottom: 4px solid #16a34a;
  }

  /* D-League playoff tier (ranks 3-4) - same background as Premier League playoff but no special border */
  tbody tr.dleague-playoff-tier {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.12) 0%, rgba(34, 197, 94, 0.08) 100%);
  }

  tbody tr.dleague-playoff-tier .rank-number {
    background: #22c55e;
    color: #fff;
  }

  /* Promotion/Relegation arrows */
  .promo-arrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 700;
    margin-left: 0.5rem;
  }

  /* D-League arrows */
  .promo-arrow.rank-2 {
    color: #22c55e;
  }

  .promo-arrow.rank-3,
  .promo-arrow.rank-4 {
    color: #fff;
    filter: drop-shadow(0 0 1px #22c55e);
  }

  /* Premier League arrows */
  .promo-arrow.pl-rank-2 {
    color: #22c55e;
  }

  .promo-arrow.pl-rank-9,
  .promo-arrow.pl-rank-10 {
    color: #fff;
    filter: drop-shadow(0 0 1px #ef4444);
  }

  .promo-arrow.pl-rank-11,
  .promo-arrow.pl-rank-12 {
    color: #ef4444;
  }

  @media (max-width: 767px) {
    .tier-logo {
      height: 35px;
    }

    .tier-header {
      font-size: 1.25rem;
    }

    .tier-standings-table {
      font-size: 0.8rem;
    }

    th {
      padding: 0.5rem;
      font-size: 0.7rem;
    }

    td {
      padding: 0.75rem 0.5rem;
    }

    .team-icon {
      width: 32px;
      height: 32px;
    }

    .rank-number {
      width: 28px;
      height: 28px;
      font-size: 0.75rem;
    }
  }
</style>
