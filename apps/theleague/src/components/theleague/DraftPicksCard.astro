---
/**
 * DraftPicksCard - Displays a team's draft picks for next season
 * Shows picks in order from best to worst with trade history
 * Can display either predicted or actual picks (with current ownership)
 */

import type { DraftPrediction } from '../../types/standings';
import { formatTradeChain } from '../../utils/draft-utils';

interface ActualDraftPick {
  round: string;
  pick: string;
  overallPickNumber: number;
  currentFranchiseId: string;
  currentTeamName: string;
  originalTeamName?: string;
  originalTeamIcon?: string;
  isTraded: boolean;
}

export interface Props {
  franchiseId: string;
  draftPredictions: DraftPrediction[];
  actualPicks?: ActualDraftPick[];
  season: number;
}

const { franchiseId, draftPredictions, actualPicks, season } = Astro.props;

// If actual picks are provided, use those; otherwise fall back to predictions
const picksToDisplay = actualPicks && actualPicks.length > 0 ? actualPicks : null;

// Filter picks for this team and sort by overall pick number
let teamPicks: Array<DraftPrediction | ActualDraftPick> = [];
let teamName = 'Unknown Team';

if (picksToDisplay) {
  // Displaying actual picks
  teamPicks = picksToDisplay
    .filter((p) => p.currentFranchiseId === franchiseId)
    .sort((a, b) => a.overallPickNumber - b.overallPickNumber);
  const firstActual = teamPicks[0] as ActualDraftPick | undefined;
  teamName = firstActual?.currentTeamName || 'Unknown Team';
} else {
  // Displaying predicted picks
  const predictionPicks = draftPredictions
    .filter((p) => p.franchiseId === franchiseId)
    .sort((a, b) => a.overallPickNumber - b.overallPickNumber);
  teamPicks = predictionPicks;
  teamName = predictionPicks[0]?.teamName || 'Unknown Team';
}

// Helper function to check if pick is actual
const isActualPick = (pick: DraftPrediction | ActualDraftPick): pick is ActualDraftPick => {
  return 'currentFranchiseId' in pick;
};

// Helper to get pick number string
const getPickNumber = (pick: DraftPrediction | ActualDraftPick): string => {
  if (isActualPick(pick)) {
    return `${pick.round}.${String(pick.pick).padStart(2, '0')}`;
  } else {
    return `${pick.round}.${String(pick.pickInRound).padStart(2, '0')}`;
  }
};
---

<div class="draft-picks-card">
  {teamPicks.length > 0 ? (
    <div class="draft-picks-list">
      {teamPicks.map((pick) => {
        const actualPick = isActualPick(pick) ? pick : null;
        const isTraded = actualPick?.isTraded || false;
        return (
          <div
            class:list={[
              'draft-pick-row',
              {
                'draft-pick-row--traded': isTraded,
                'draft-pick-row--league-winner': !actualPick && 'isLeagueWinner' in pick && pick.isLeagueWinner,
                'draft-pick-row--toilet-bowl': !actualPick && 'isToiletBowlPick' in pick && pick.isToiletBowlPick,
              },
            ]}
          >
            <div class="draft-pick-row__pick">
              <div class="draft-pick-row__number">
                {getPickNumber(pick)}
              </div>
            </div>
            {actualPick && (
              <div class="draft-pick-row__icon-container">
                <img src="/assets/nfl-logos/placeholder.png" alt={actualPick.currentTeamName} class="draft-pick-row__icon" />
                {actualPick.isTraded && actualPick.originalTeamIcon && (
                  <img
                    src={actualPick.originalTeamIcon}
                    alt={actualPick.originalTeamName}
                    class="draft-pick-row__icon draft-pick-row__icon--original"
                    title={`Originally from ${actualPick.originalTeamName}`}
                  />
                )}
              </div>
            )}
            <div class="draft-pick-row__details">
              <div class="draft-pick-row__rank">#{pick.overallPickNumber}</div>
              {actualPick && actualPick.isTraded && actualPick.originalTeamName && (
                <div class="draft-pick-row__trade">
                  from {actualPick.originalTeamName}
                </div>
              )}
              {'tradeHistory' in pick && pick.tradeHistory && (
                <div class="draft-pick-row__trade">
                  {formatTradeChain(
                    [pick.tradeHistory.originalTeam, ...pick.tradeHistory.chain.map((c) => c.team)]
                  )}
                </div>
              )}
            </div>
            {!actualPick && 'isLeagueWinner' in pick && pick.isLeagueWinner && (
              <span class="draft-pick-row__badge draft-pick-row__badge--champion" title="League Champion">
                ‚ôî
              </span>
            )}
            {!actualPick && 'isToiletBowlPick' in pick && pick.isToiletBowlPick && (
              <span
                class="draft-pick-row__badge draft-pick-row__badge--toilet-bowl"
                title={`Toilet Bowl ${('toiletBowlType' in pick ? pick.toiletBowlType : '')}`}
              >
                üèÜ
              </span>
            )}
            {actualPick && actualPick.isTraded && (
              <span class="draft-pick-row__badge draft-pick-row__badge--traded" title="Traded pick">
                ‚Üî
              </span>
            )}
          </div>
        );
      })}
    </div>
  ) : (
    <div class="draft-picks-empty">
      <p>No draft picks available for {season}</p>
    </div>
  )}
</div>

<style>
  .draft-picks-card {
    display: grid;
    gap: 0.75rem;
  }

  .draft-picks-list {
    display: grid;
    gap: 0.5rem;
  }

  .draft-pick-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem;
    border-radius: 0.5rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    transition: background-color 0.2s ease, border-color 0.2s ease;
  }

  .draft-pick-row:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .draft-pick-row--league-winner {
    background: #fffbeb;
    border-color: #fbbf24;
  }

  .draft-pick-row--league-winner:hover {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  .draft-pick-row--toilet-bowl {
    background: #fef2f2;
    border-color: #fecaca;
  }

  .draft-pick-row--toilet-bowl:hover {
    background: #fee2e2;
    border-color: #ff6b6b;
  }

  .draft-pick-row__pick {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
  }

  .draft-pick-row--league-winner .draft-pick-row__pick {
    background: #fbbf24;
    border-color: #f59e0b;
    color: #fff;
  }

  .draft-pick-row--toilet-bowl .draft-pick-row__pick {
    background: #fff;
    border-color: #ff6b6b;
  }

  .draft-pick-row__number {
    font-size: 0.875rem;
    font-weight: 700;
    text-align: center;
    line-height: 1;
  }

  .draft-pick-row__icon-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    flex-shrink: 0;
  }

  .draft-pick-row__icon {
    width: 2rem;
    height: 2rem;
    object-fit: contain;
    flex-shrink: 0;
  }

  .draft-pick-row__icon--original {
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 1rem;
    height: 1rem;
    border: 1px solid #fff;
    border-radius: 50%;
    object-fit: contain;
  }

  .draft-pick-row__details {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    flex: 1;
    min-width: 0;
  }

  .draft-pick-row__rank {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
  }

  .draft-pick-row__trade {
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .draft-pick-row__badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    font-size: 0.875rem;
    cursor: help;
  }

  .draft-pick-row__badge--champion {
    color: #fbbf24;
  }

  .draft-pick-row__badge--toilet-bowl {
    color: #ff6b6b;
  }

  .draft-pick-row__badge--traded {
    color: #8b5cf6;
  }

  .draft-pick-row--traded {
    background: #faf5ff;
    border-color: #ddd6fe;
  }

  .draft-pick-row--traded:hover {
    background: #f3e8ff;
    border-color: #c4b5fd;
  }

  .draft-picks-empty {
    padding: 2rem 1rem;
    text-align: center;
    color: #64748b;
    font-size: 0.875rem;
  }

  @media (max-width: 640px) {
    .draft-picks-card__title {
      font-size: 1rem;
    }

    .draft-pick-row {
      padding: 0.5rem;
      gap: 0.5rem;
    }

    .draft-pick-row__pick {
      width: 2.25rem;
      height: 2.25rem;
    }

    .draft-pick-row__number {
      font-size: 0.75rem;
    }

    .draft-pick-row__rank {
      font-size: 0.7rem;
    }

    .draft-pick-row__trade {
      font-size: 0.7rem;
    }

    .draft-pick-row__icon-container {
      width: 1.75rem;
      height: 1.75rem;
    }

    .draft-pick-row__icon {
      width: 1.75rem;
      height: 1.75rem;
    }

    .draft-pick-row__icon--original {
      width: 0.875rem;
      height: 0.875rem;
      bottom: -3px;
      right: -3px;
    }
  }
</style>
