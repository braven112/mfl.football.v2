---
import type { TeamStanding } from '../../types/standings';

export interface Props {
  teams: TeamStanding[];
  year?: number;
}

const { teams, year = new Date().getFullYear() } = Astro.props;

function parseWLT(wlt: string | undefined) {
  if (!wlt) return { w: 0, l: 0, t: 0 };
  const parts = wlt.split('-').map(Number);
  return { w: parts[0] || 0, l: parts[1] || 0, t: parts[2] || 0 };
}

// Derive all_play_wlt from percentage when the record is missing
// NFL schedule: 16 weeks × 15 opponents = 240 games (2020 and earlier)
//               17 weeks × 15 opponents = 255 games (2021+)
// Returns null if percentage data is not available
function deriveAllPlayWLT(pct: string | undefined, seasonYear: number): { w: number; l: number; t: number } | null {
  if (!pct) return null; // No data available
  const TOTAL_GAMES = seasonYear >= 2021 ? 255 : 240;
  const percentage = parseFloat(pct);
  if (isNaN(percentage)) return null;
  const wins = Math.round(TOTAL_GAMES * percentage);
  const losses = TOTAL_GAMES - wins;
  return { w: wins, l: losses, t: 0 };
}

function safeParseFloat(value: string | undefined, decimals: number): string {
  if (!value) return (0).toFixed(decimals);
  return parseFloat(value).toFixed(decimals);
}

function safeParseInt(value: string | undefined): string {
  if (!value) return '0';
  return parseInt(value).toString();
}

function getRowColor(seed: number | undefined): string {
  if (!seed) return '';
  if (seed <= 4) return 'tier-division-winners';
  if (seed <= 7) return 'tier-wild-cards';
  if (seed <= 9) return 'tier-play-in';
  return 'tier-toilet-bowl';
}
---
<div class="standings-container">
<div class="league-standings-wrapper">
  
  <div class="table-wrapper">
    <table class="league-standings-table">
      <thead>
        <tr>
          <th class="col-seed">Seed</th>
          <th class="col-team">Team</th>
          <th class="col-overall-record">Overall</th>
          <th class="col-overall-pct">PCT</th>
          <th class="col-div-record">Div</th>
          <th class="col-div-pct">PCT</th>
          <th class="col-allplay">All Play</th>
          <th class="col-pf">PF</th>
          <th class="col-pwr">PWR</th>
          <th class="col-vp">VP</th>
          <th class="col-pa">PA</th>
        </tr>
      </thead>
      <tbody>
        {teams.map((team, index) => {
          const overallRecord = parseWLT(team.h2hwlt);
          const divRecord = parseWLT(team.divwlt);
          // Use provided all_play_wlt, or derive from percentage if missing
          const allPlayRecord = team.all_play_wlt
            ? parseWLT(team.all_play_wlt)
            : deriveAllPlayWLT(team.all_play_pct, year);
          const rowColor = getRowColor(team.seed);
          const nextTeam = teams[index + 1];
          const nextTier = nextTeam ? getRowColor(nextTeam.seed) : '';
          const isTierBoundary = rowColor !== nextTier && nextTeam;

          return (
            <tr class={`league-row ${rowColor} ${isTierBoundary ? 'tier-boundary' : ''}`}>
              <td class="col-seed">
                <span class="seed-number">#{team.seed}</span>
              </td>
              <td class="col-team">
                <div class="team-info">
                  {team.teamBanner && (
                    <img
                      src={team.teamBanner}
                      alt={team.teamName}
                      class="team-banner"
                      title={team.teamName}
                    />
                  )}
                </div>
              </td>
              <td class="col-overall-record">
                {overallRecord.w}-{overallRecord.l}-{overallRecord.t}
              </td>
              <td class="col-overall-pct">
                {safeParseFloat(team.h2hpct, 3)}
              </td>
              <td class="col-div-record">
                {divRecord.w}-{divRecord.l}-{divRecord.t}
              </td>
              <td class="col-div-pct">
                {safeParseFloat(team.divpct, 3)}
              </td>
              <td class="col-allplay">
                {allPlayRecord ? `${allPlayRecord.w}-${allPlayRecord.l}-${allPlayRecord.t}` : 'N/A'}
              </td>
              <td class="col-pf">
                {safeParseFloat(team.pf, 1)}
              </td>
              <td class="col-pwr">
                {safeParseFloat(team.pwr, 1)}
              </td>
              <td class="col-vp">
                {safeParseInt(team.vp)}
              </td>
              <td class="col-pa">
                {safeParseFloat(team.pa, 1)}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</div>
</div>

<style>
    .standings-container {
    margin-bottom: 2rem;
    background-color: var(--primary-content-bg-color, #fff);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: var(--padding-md);
    overflow-x: auto;
  }
  .league-standings-wrapper {
    width: 100%;
  }

  .league-standings-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--color-bg-secondary, #f5f5f5);
  }

  thead {
    background-color: var(--primary-content-bg-color, #fff);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--table-header-text-color, #94a3b8);
    border-bottom: 2px solid var(--color-border, #d0d0d0);
  }

  td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border, #e0e0e0);
    font-size: var(--table-cell-font-size, .75rem);
    color: #000;
  }

  tbody tr {
    transition: opacity 0.2s ease;
  }

  tbody tr:hover {
    opacity: 0.85;
  }

  /* Tier Color Schemes - WCAG 2.0 AA compliant with black text */

  /* Division Winners - Light Gold (Tier 1-4) */
  .tier-division-winners {
    background-color: #fef8e7;
  }

  /* Wild Cards - Light Silver (Tier 5-7) */
  .tier-wild-cards {
    background-color: #f3f3f3;
  }

  /* Play-In - No Color (Tier 8-9) */
  .tier-play-in {
    background-color: var(--color-bg-primary, #fff);
  }

  /* Toilet Bowl - Light Brown (Tier 10-16) */
  .tier-toilet-bowl {
    background-color: #f5e6d3;
  }

  /* Tier Boundary Dividers */
  .tier-division-winners.tier-boundary {
    border-bottom: 4px solid #d4a856 !important;
  }

  .tier-wild-cards.tier-boundary {
    border-bottom: 4px solid #d8d8d8 !important;
  }

  .tier-play-in.tier-boundary {
    border-bottom: 4px solid #dad8d5 !important;
  }

  .tier-toilet-bowl.tier-boundary {
    border-bottom: 4px solid #dad8d5 !important;
  }

  /* Column Widths */
  .col-seed {
    width: 80px;
    text-align: center;
    font-weight: 600;
  }

  .col-team {
    width: auto;
    min-width: 250px;
  }

  .col-overall-record {
    width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .col-overall-pct {
    width: 90px;
    text-align: center;
  }

  .col-div-record {
    width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .col-div-pct {
    width: 90px;
    text-align: center;
  }

  .col-allplay {
    width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .col-pf,
  .col-pa {
    width: 110px;
    text-align: right;
  }

  .col-pwr {
    width: 100px;
    text-align: center;
  }

  .col-vp {
    width: 90px;
    text-align: center;
  }

  /* Team Info */
  .team-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .team-banner {
    width: 100%;
    max-width: 400px;
    height: auto;
    object-fit: contain;
  }

  .seed-number {
    font-weight: 700;
    font-size: 1rem;
    display: inline-block;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .col-team {
      min-width: 100px;
    }

    .col-pf,
    .col-pa,
    .col-pwr {
      font-size: 0.8rem;
      padding: 0.5rem;
    }

    th {
      font-size: 0.75rem;
      padding: 0.5rem;
    }

    td {
      padding: 0.5rem;
      font-size: 0.85rem;
    }

    .team-banner {
      max-width: 200px;
    }

    .seed-number {
      font-size: 0.9rem;
    }
  }
</style>
