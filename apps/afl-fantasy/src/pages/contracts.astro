---
import TheLeagueLayout from '../layouts/TheLeagueLayout.astro';
import { getContractWindow } from '@mfl/league-utils';
import transactionData from '../data/mfl-feeds/2025/transactions.json';
import leagueAssets from '../../../../data/afl-fantasy/assets.json';

// Get current contract window status
const windowStatus = getContractWindow();

// Import player salary data
const playerDataModules = import.meta.glob('../data/mfl-player-salaries-*.json', {
  eager: true,
});

// Get the most recent player data
const getLatestPlayerData = () => {
  const modules = Object.entries(playerDataModules)
    .sort(([pathA], [pathB]) => pathB.localeCompare(pathA))
    .slice(0, 1);

  if (modules.length === 0) return null;

  const [, module] = modules[0];
  const data = (module as any).default || module;
  return data;
};

const playerData = getLatestPlayerData();
const allPlayers = playerData?.players || [];

// Get franchise ID from URL parameter or show login prompt
const franchiseId = Astro.url.searchParams.get('franchise') || '';
const leagueId = playerData?.metadata?.leagueId || '13522';

// Determine which players are eligible based on acquisition window
// Rules:
// - Offseason (Feb 15 - 3rd Sunday Aug): 48 hours after acquisition
// - Regular Season (3rd Sunday Aug 8:45pm - end of year): 24 hours after acquisition

const nowTimestamp = Math.floor(Date.now() / 1000);
const currentYear = new Date().getFullYear();

// Calculate 3rd Sunday in August at 8:45 PM PT
function getThirdSundayAugust(year: number): number {
  const august1 = new Date(year, 7, 1);
  let dayOfWeek = august1.getDay();
  const daysToFirstSunday = (7 - dayOfWeek) % 7 || 7;
  const thirdSunday = new Date(year, 7, 1 + daysToFirstSunday + 14);
  thirdSunday.setHours(20, 45, 0, 0); // 8:45 PM PT
  return Math.floor(thirdSunday.getTime() / 1000);
}

const thirdSundayAug = getThirdSundayAugust(currentYear);
const isRegularSeason = nowTimestamp >= thirdSundayAug;
const eligibilityWindowHours = isRegularSeason ? 24 : 48;
const eligibilityWindowSeconds = eligibilityWindowHours * 60 * 60;
const eligibilityDeadline = nowTimestamp - eligibilityWindowSeconds;

// Extract eligible players from transactions
const recentlyAddedPlayerIds = new Set<string>();

if (transactionData?.transactions?.transaction) {
  const transactions = Array.isArray(transactionData.transactions.transaction)
    ? transactionData.transactions.transaction
    : [transactionData.transactions.transaction];

  transactions.forEach((txn: any) => {
    const txnTimestamp = parseInt(txn.timestamp);

    // Only consider transactions within the eligibility window
    if (txnTimestamp >= eligibilityDeadline) {
      // FREE_AGENT transactions add players to a franchise
      if (txn.type === 'FREE_AGENT' && txn.transaction) {
        // Extract player IDs from transaction field (format: "playerid,|" or "|playerid,")
        const playerIds = txn.transaction
          .split('|')
          .filter((id: string) => id.trim())
          .map((id: string) => id.replace(/,/g, '').trim());
        playerIds.forEach((id: string) => {
          if (id) recentlyAddedPlayerIds.add(id);
        });
      }
      // BBID_WAIVER transactions (auction acquisitions)
      if (txn.type === 'BBID_WAIVER' && txn.transaction) {
        const playerIds = txn.transaction
          .split('|')
          .filter((id: string) => id && !id.includes('|'))
          .map((id: string) => id.replace(/,/g, '').trim());
        playerIds.forEach((id: string) => {
          if (id && !isNaN(parseInt(id))) recentlyAddedPlayerIds.add(id);
        });
      }
    }
  });
}

// Filter players for this franchise that were recently added
// (eligible for contract modification)
const franchisePlayers = allPlayers
  .filter((p: any) =>
    p.franchiseId === franchiseId &&
    p.status === 'ROSTER' &&
    p.contractYear &&
    recentlyAddedPlayerIds.has(p.id)
  )
  .sort((a: any, b: any) => a.name.localeCompare(b.name));

// Group players by position
const playersByPosition = franchisePlayers.reduce((acc: any, player: any) => {
  if (!acc[player.position]) {
    acc[player.position] = [];
  }
  acc[player.position].push(player);
  return acc;
}, {} as Record<string, any[]>);

// Get all available franchises
const allFranchises = leagueAssets.teams;

// Serialize configuration for client-side use
const serializedConfig = JSON.stringify({
  windowStatus,
  franchisePlayers,
  playersByPosition,
  leagueId,
  franchiseId,
  allFranchises,
  selectedFranchiseName: allFranchises?.find((f: any) => f.id === franchiseId)?.name || 'Select Team',
});
---

<TheLeagueLayout title="Contract Management">
  <main class="view-container">
    <section class="contracts-section">
      <div class="section-header">
        <h1>Contract Management</h1>
        <p class="section-subtitle">Set contract years for your franchise players during the contract setting window</p>
      </div>

      {!franchiseId && (
        <div class="franchise-selector">
          <h2>Select Your Team</h2>
          <p>Choose which franchise you want to manage contracts for:</p>
          <div class="franchise-grid">
            {allFranchises?.map((franchise: any) => (
              <a
                href={`?franchise=${franchise.id}`}
                class="franchise-card"
                title={`${franchise.name} - ${franchise.division}`}
              >
                <img
                  src={franchise.assets?.icons?.[0]?.relativePath || '/assets/placeholder.png'}
                  alt={franchise.name}
                  class="franchise-icon"
                  onerror="this.src='/assets/placeholder.png'"
                />
                <span class="franchise-name">{franchise.name}</span>
                <span class="franchise-division">{franchise.division}</span>
              </a>
            ))}
          </div>
        </div>
      )}

      {franchiseId && (
        <>
          <div class="franchise-header">
            <a href="/contracts" class="back-link">‚Üê Back to Team Selection</a>
            <h2 class="franchise-title">{leagueId === '13522' ? 'The League' : 'Test League'} - Managing {allFranchises?.find((f: any) => f.id === franchiseId)?.name}</h2>
          </div>

          <div class="testing-panel" id="testingPanel">
            <details open>
              <summary>üß™ Testing & Debug Options</summary>
              <div class="testing-content">
                <div class="test-section league-info">
                  <div class="league-badge">
                    <strong>League ID:</strong> <span id="leagueIdDisplay" class="league-id-value">{leagueId}</span>
                    {leagueId === '13522' && <span class="badge badge-production">PRODUCTION</span>}
                    {leagueId !== '13522' && <span class="badge badge-test">TEST</span>}
                  </div>
                </div>

                <div class="test-section">
                  <label for="simulatedTime">Simulated Current Time (for testing):</label>
                  <input type="datetime-local" id="simulatedTime" class="test-input" />
                  <button id="resetTimeBtn" class="btn btn-secondary">Reset to Now</button>
                  <p class="test-info"><small>This adjusts which transactions qualify as "recently acquired" for testing purposes.</small></p>
                </div>

                <div class="test-section">
                  <h4>Eligible Players Debug</h4>
                  <div id="eligibilityDebug" class="debug-output">Loading...</div>
                </div>
              </div>
            </details>
          </div>

          {!windowStatus.inWindow && (
            <div class="window-status window-status--closed">
              <h3>Contract Window Closed</h3>
              <p>{windowStatus.reason}</p>
            </div>
          )}

          {windowStatus.inWindow && (
            <div class="window-status window-status--open">
              <h3>Contract Window Open</h3>
              <p>
                {windowStatus.windowType === 'offseason'
                  ? 'Offseason window active - You can set contract years now'
                  : 'In-season window active - Limited contract setting allowed'}
              </p>
            </div>
          )}

          <div class="contracts-container">
            <section class="contract-form-section">
              <h2>Submit Contract Change</h2>

              {franchisePlayers.length === 0 ? (
                <div class="empty-state">
                  <p>No players with contract years found for your franchise.</p>
                  <p class="empty-hint">Players must be on your roster with an active contract to modify contract years.</p>
                </div>
              ) : (
                <form id="contractForm" class="contract-form">
                  <div class="form-group">
                    <label for="playerSelect" class="form-label">
                      Select Player <span class="required">*</span>
                    </label>
                    <select id="playerSelect" name="playerSelect" class="form-input" required>
                      <option value="">-- Choose a player --</option>
                      {franchisePlayers.map((player: any) => (
                        <option
                          value={player.id}
                          data-years={player.contractYear}
                          data-name={player.name}
                          data-position={player.position}
                          data-salary={player.salary}
                        >
                          {player.name} ({player.position}) - {player.contractYear} yr{player.contractYear !== '1' ? 's' : ''}
                        </option>
                      ))}
                    </select>
                  </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="currentYears" class="form-label">
                    Current Years
                  </label>
                  <input
                    type="number"
                    id="currentYears"
                    name="currentYears"
                    class="form-input"
                    readonly
                    placeholder="Select a player"
                  />
                </div>

                <div class="form-group">
                  <label for="newYears" class="form-label">
                    New Years <span class="required">*</span>
                  </label>
                  <input
                    type="number"
                    id="newYears"
                    name="newYears"
                    class="form-input"
                    min="1"
                    max="5"
                    placeholder="1-5"
                    required
                  />
                </div>
              </div>

              <div class="form-errors" id="formErrors"></div>

              <button
                type="submit"
                class="btn btn-primary"
                id="submitBtn"
                disabled={!windowStatus.inWindow}
              >
                {windowStatus.inWindow ? 'Submit Contract' : 'Window Closed'}
              </button>
                </form>
              )}
            </section>

            <section class="contract-info-section">
              <h2>Contract Setting Rules</h2>
              <div class="rules-list">
                <div class="rule-item">
                  <h4>Offseason Window</h4>
                  <p>February 15 - 3rd Sunday in August at 8:45 PM PT</p>
                </div>
                <div class="rule-item">
                  <h4>In-Season Window</h4>
                  <p>Weeks 1-17 (Limited contract setting)</p>
                </div>
                <div class="rule-item">
                  <h4>Contract Years</h4>
                  <p>Must be a whole number between 1 and 5 years</p>
                </div>
                <div class="rule-item">
                  <h4>Eligible Players</h4>
                  <p>Players with active contracts on your roster</p>
                </div>
              </div>
            </section>
          </div>

          <section class="transaction-section">
            <h2>Recent Submissions</h2>
            <div id="recentTransactions" class="transactions-list">
              <p class="loading-text">Loading transaction history...</p>
            </div>
          </section>
        </>
      )}
    </section>
  </main>

  <script type="application/json" id="contract-config" set:html={serializedConfig}></script>

  <script type="module">
    // Load configuration
    const configEl = document.getElementById('contract-config');
    const config = JSON.parse(configEl?.textContent || '{}');

    // Get form elements
    const contractForm = document.getElementById('contractForm');
    const playerSelect = document.getElementById('playerSelect');
    const currentYearsInput = document.getElementById('currentYears');
    const newYearsInput = document.getElementById('newYears');
    const submitBtn = document.getElementById('submitBtn');
    const formErrors = document.getElementById('formErrors');
    const recentTransactions = document.getElementById('recentTransactions');

    // Testing panel elements
    const simulatedTimeInput = document.getElementById('simulatedTime');
    const resetTimeBtn = document.getElementById('resetTimeBtn');
    const eligibilityDebug = document.getElementById('eligibilityDebug');

    // Set initial simulated time to now
    if (simulatedTimeInput) {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      simulatedTimeInput.value = localDateTime;
      updateEligibilityDebug();
    }

    // Reset to current time
    resetTimeBtn?.addEventListener('click', () => {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      simulatedTimeInput.value = localDateTime;
      updateEligibilityDebug();
    });

    // Update debug info when time changes
    simulatedTimeInput?.addEventListener('change', updateEligibilityDebug);

    function updateEligibilityDebug() {
      if (!simulatedTimeInput || !config.franchisePlayers) return;

      const simulatedTime = new Date(simulatedTimeInput.value);
      const nowTimestamp = Math.floor(simulatedTime.getTime() / 1000);
      const currentYear = simulatedTime.getFullYear();

      // Calculate 3rd Sunday in August at 8:45 PM PT
      function getThirdSundayAugust(year) {
        const august1 = new Date(year, 7, 1);
        let dayOfWeek = august1.getDay();
        const daysToFirstSunday = (7 - dayOfWeek) % 7 || 7;
        const thirdSunday = new Date(year, 7, 1 + daysToFirstSunday + 14);
        thirdSunday.setHours(20, 45, 0, 0); // 8:45 PM PT
        return Math.floor(thirdSunday.getTime() / 1000);
      }

      const thirdSundayAug = getThirdSundayAugust(currentYear);
      const isRegularSeason = nowTimestamp >= thirdSundayAug;
      const eligibilityWindowHours = isRegularSeason ? 24 : 48;
      const eligibilityDeadline = nowTimestamp - eligibilityWindowHours * 3600;

      // Count eligible players for this franchise
      const eligiblePlayers = config.franchisePlayers.filter(p => {
        // In real scenario, we'd check if player was in recentlyAddedPlayerIds
        // For testing, we'll show all roster players with contract years
        return p.franchiseId === config.franchiseId;
      });

      const thirdSundayDate = new Date(thirdSundayAug * 1000);
      const season = isRegularSeason ? 'Regular Season' : 'Offseason';
      const deadlineDate = new Date(eligibilityDeadline * 1000);

      eligibilityDebug.innerHTML = `
        <div class="debug-info">
          <p><strong>Simulated Time:</strong> ${simulatedTime.toLocaleString()}</p>
          <p><strong>Current Season:</strong> ${season}</p>
          <p><strong>3rd Sunday August:</strong> ${thirdSundayDate.toLocaleString()}</p>
          <p><strong>Eligibility Window:</strong> ${eligibilityWindowHours} hours</p>
          <p><strong>Transaction Deadline (${eligibilityWindowHours}h ago):</strong> ${deadlineDate.toLocaleString()}</p>
          <p><strong>Eligible Players for ${config.selectedFranchiseName}:</strong> ${eligiblePlayers.length}</p>
          ${eligiblePlayers.length > 0 ? `
            <div class="eligible-players-list">
              ${eligiblePlayers.map(p => `
                <div class="eligible-player-item">
                  <span class="player-name">${p.name}</span>
                  <span class="player-pos">${p.position}</span>
                  <span class="player-years">${p.contractYear}yr</span>
                </div>
              `).join('')}
            </div>
          ` : '<p style="color: #999;">No eligible players</p>'}
        </div>
      `;
    }

    // Update current years when player is selected
    playerSelect?.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      if (selectedOption.value) {
        const currentYears = selectedOption.dataset.years;
        currentYearsInput.value = currentYears || '';
        newYearsInput.value = ''; // Reset new years input
        newYearsInput.focus();
      } else {
        currentYearsInput.value = '';
        newYearsInput.value = '';
      }
    });

    // Form submission
    contractForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      formErrors.innerHTML = '';

      const selectedOption = playerSelect.options[playerSelect.selectedIndex];
      const playerName = selectedOption.dataset.name;
      const playerId = playerSelect.value;
      const oldYears = parseInt(currentYearsInput.value);
      const newYears = parseInt(newYearsInput.value);

      // Client-side validation
      if (!playerId) {
        showError('Please select a player');
        return;
      }

      if (!newYears || newYears < 1 || newYears > 5 || !Number.isInteger(newYears)) {
        showError('Contract years must be a whole number between 1 and 5');
        return;
      }

      if (oldYears === newYears) {
        showError('New contract years must be different from current years');
        return;
      }

      // Disable submit button during request
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const response = await fetch('/api/contracts/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            leagueId: config.leagueId,
            playerId,
            playerName,
            franchiseId: config.franchiseId,
            oldContractYears: oldYears,
            newContractYears: newYears,
            submittedBy: config.selectedFranchiseName,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          // Handle validation errors
          if (data.errors && Array.isArray(data.errors)) {
            data.errors.forEach(err => {
              showError(err.message);
            });
          } else {
            showError(data.message || 'Failed to submit contract');
          }
          return;
        }

        // Success
        showSuccess(`Contract for ${playerName} updated to ${newYears} years`, data.transactionId);
        contractForm.reset();
        currentYearsInput.value = '';
        loadRecentTransactions();

      } catch (error) {
        showError(error instanceof Error ? error.message : 'Network error');
      } finally {
        submitBtn.disabled = !config.windowStatus.inWindow;
        submitBtn.textContent = 'Submit Contract';
      }
    });

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'form-error';
      errorDiv.textContent = message;
      formErrors.appendChild(errorDiv);
    }

    function showSuccess(message, transactionId) {
      const successDiv = document.createElement('div');
      successDiv.className = 'form-success';
      successDiv.innerHTML = `<strong>${message}</strong><br><small>Transaction ID: ${transactionId}</small>`;
      formErrors.appendChild(successDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => successDiv.remove(), 5000);
    }

    async function loadRecentTransactions() {
      try {
        const response = await fetch('/api/contracts/submit');
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();
        const transactions = data.transactions || [];

        if (transactions.length === 0) {
          recentTransactions.innerHTML = '<p class="empty-text">No contract submissions yet</p>';
          return;
        }

        const html = transactions.slice(0, 5).map(t => `
          <div class="transaction-item transaction-item--${t.status}">
            <div class="transaction-header">
              <span class="transaction-player">${t.playerName}</span>
              <span class="transaction-status">${t.status.toUpperCase()}</span>
            </div>
            <div class="transaction-details">
              <span>${t.oldContractYears} ‚Üí ${t.newContractYears} years</span>
              <span class="transaction-date">${new Date(t.submittedAt).toLocaleDateString()}</span>
            </div>
          </div>
        `).join('');

        recentTransactions.innerHTML = html;

      } catch (error) {
        recentTransactions.innerHTML = '<p class="error-text">Failed to load transactions</p>';
      }
    }

    // Load transactions on page load
    loadRecentTransactions();
  </script>

  <style>
    .view-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .contracts-section {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .section-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .section-header h1 {
      font-size: 2rem;
      color: var(--primary-color);
      margin: 0;
    }

    .section-subtitle {
      font-size: 1rem;
      color: #666;
      margin: 0;
    }

    .franchise-selector {
      background: var(--primary-content-bg-color);
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.75rem;
      padding: 2rem;
      box-shadow: var(--primary-content-boxshadow-size) var(--primary-content-boxshadow-color);
    }

    .franchise-selector h2 {
      color: var(--primary-color);
      margin-top: 0;
      font-size: 1.5rem;
    }

    .franchise-selector > p {
      color: #666;
      margin-bottom: 1.5rem;
    }

    .franchise-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }

    .franchise-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border: 2px solid var(--primary-content-border-color);
      border-radius: 0.5rem;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }

    .franchise-card:hover {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(28, 73, 124, 0.1);
      transform: translateY(-2px);
    }

    .franchise-icon {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 0.75rem;
    }

    .franchise-name {
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      color: #333;
      line-height: 1.2;
      margin-bottom: 0.25rem;
    }

    .franchise-division {
      font-size: 0.75rem;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .franchise-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .back-link {
      color: var(--primary-color);
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      width: fit-content;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .franchise-title {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.25rem;
    }

    .empty-hint {
      color: #999;
      font-size: 0.9rem;
    }

    .window-status {
      padding: 1.5rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
    }

    .window-status--open {
      background: #f0fdf4;
      border-left-color: var(--success-color);
    }

    .window-status--open h3 {
      color: var(--success-color);
    }

    .window-status--closed {
      background: #fef2f2;
      border-left-color: var(--error-color);
    }

    .window-status--closed h3 {
      color: var(--error-color);
    }

    .window-status h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.125rem;
    }

    .window-status p {
      margin: 0;
      font-size: 0.95rem;
    }

    .contracts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 768px) {
      .contracts-container {
        grid-template-columns: 2fr 1fr;
      }
    }

    .contract-form-section,
    .contract-info-section {
      background: var(--primary-content-bg-color);
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--primary-content-boxshadow-size) var(--primary-content-boxshadow-color);
    }

    .contract-form-section h2,
    .contract-info-section h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .contract-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-label {
      font-weight: 500;
      color: #333;
      font-size: 0.95rem;
    }

    .required {
      color: var(--error-color);
    }

    .form-input {
      padding: 0.75rem;
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(28, 73, 124, 0.1);
    }

    .form-input:disabled {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .form-errors {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 0;
    }

    .form-error {
      padding: 0.75rem;
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 0.5rem;
      color: var(--error-color);
      font-size: 0.9rem;
    }

    .form-success {
      padding: 0.75rem;
      background-color: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 0.5rem;
      color: var(--success-color);
      font-size: 0.9rem;
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: var(--primary-btn-default-bg-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-btn-hover-bg-color);
    }

    .btn-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .empty-state {
      padding: 2rem;
      text-align: center;
      color: #999;
    }

    .rules-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .rule-item {
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary-color);
    }

    .rule-item h4 {
      margin: 0 0 0.5rem 0;
      color: var(--primary-color);
      font-size: 0.95rem;
    }

    .rule-item p {
      margin: 0;
      font-size: 0.9rem;
      color: #666;
    }

    .transaction-section {
      background: var(--primary-content-bg-color);
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--primary-content-boxshadow-size) var(--primary-content-boxshadow-color);
    }

    .transaction-section h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .transactions-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .transaction-item {
      padding: 1rem;
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.5rem;
      border-left: 4px solid #ccc;
    }

    .transaction-item--pending {
      background-color: #fffbeb;
      border-left-color: var(--warning-color);
    }

    .transaction-item--success {
      background-color: #f0fdf4;
      border-left-color: var(--success-color);
    }

    .transaction-item--failed {
      background-color: #fef2f2;
      border-left-color: var(--error-color);
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .transaction-player {
      font-weight: 500;
      color: #333;
    }

    .transaction-status {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      text-transform: uppercase;
    }

    .transaction-item--pending .transaction-status {
      background-color: #fef3c7;
      color: #92400e;
    }

    .transaction-item--success .transaction-status {
      background-color: #dcfce7;
      color: #166534;
    }

    .transaction-item--failed .transaction-status {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .transaction-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #666;
    }

    .transaction-date {
      color: #999;
    }

    .loading-text,
    .empty-text,
    .error-text {
      color: #999;
      text-align: center;
      padding: 1rem;
      font-size: 0.95rem;
    }

    .error-text {
      color: var(--error-color);
    }

    .testing-panel {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .league-info {
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 1rem;
      margin-bottom: 0 !important;
    }

    .league-badge {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: white;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
    }

    .league-id-value {
      font-family: 'Courier New', monospace;
      font-size: 1.1rem;
      font-weight: 700;
      color: #1c497c;
      background: #f0f4f8;
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
    }

    .badge {
      padding: 0.35rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .badge-production {
      background-color: #dcfce7;
      color: #166534;
    }

    .badge-test {
      background-color: #fef3c7;
      color: #92400e;
    }

    .testing-panel details {
      padding: 0;
    }

    .testing-panel summary {
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      color: #495057;
      background: #f1f3f5;
      user-select: none;
      transition: background 0.2s;
    }

    .testing-panel summary:hover {
      background: #e9ecef;
    }

    .testing-content {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .test-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .test-section label {
      font-weight: 500;
      color: #333;
      font-size: 0.95rem;
    }

    .test-input {
      padding: 0.75rem;
      border: 1px solid var(--primary-content-border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      max-width: 300px;
    }

    .test-info {
      color: #666;
      margin: 0;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
      display: inline-block;
      width: fit-content;
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #5a6268;
    }

    .debug-output {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1rem;
      font-size: 0.9rem;
    }

    .debug-info {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .debug-info p {
      margin: 0;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
    }

    .eligible-players-list {
      margin-top: 1rem;
      border-top: 1px solid #dee2e6;
      padding-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .eligible-player-item {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
      align-items: center;
    }

    .player-name {
      font-weight: 500;
      color: #333;
    }

    .player-pos {
      font-size: 0.85rem;
      color: #666;
      text-transform: uppercase;
      padding: 0.25rem 0.5rem;
      background: white;
      border-radius: 0.25rem;
    }

    .player-years {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
    }

    @media (max-width: 767px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .contracts-container {
        grid-template-columns: 1fr;
      }

      .view-container {
        padding: 1rem 0.75rem;
      }

      .section-header h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</TheLeagueLayout>
